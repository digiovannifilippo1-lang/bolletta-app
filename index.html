<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preventivo Energia PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0a0a14;--sf:#13132a;--sf2:#1a1a35;
      --tx:#f1f5f9;--tx2:#94a3b8;--bd:rgba(120,80,255,0.2);
      --wt:#e07020;--opt:#0ea5e9;--ok:#22c55e;--er:#ef4444;
    }
    *{margin:0;padding:0;box-sizing:border-box;}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
         background:var(--bg);color:var(--tx);padding:20px;min-height:100vh;}
    .wrap{max-width:920px;margin:0 auto;}

    .header{text-align:center;padding:26px 20px 18px;background:var(--sf);
            border-radius:16px;border:1px solid var(--bd);margin-bottom:16px;}
    .logo{font-size:1.9rem;font-weight:900;
      background:linear-gradient(135deg,#7c3aed,#06b6d4);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
    .header p{color:var(--tx2);margin-top:5px;font-size:0.9rem;}

    /* INDICI */
    .indici{display:flex;gap:14px;flex-wrap:wrap;align-items:center;
            background:var(--sf);border-radius:12px;padding:11px 16px;
            border:1px solid var(--bd);margin-bottom:16px;}
    .ic{font-size:0.82rem;display:flex;align-items:center;gap:5px;}
    .ic b{color:#a78bfa;}
    .ic-tag{font-size:0.69rem;background:rgba(120,80,255,0.18);
            border-radius:4px;padding:1px 6px;color:#c4b5fd;}
    .ic-note{margin-left:auto;font-size:0.69rem;color:var(--tx2);font-style:italic;}

    /* TABS */
    .tabs{display:flex;background:var(--sf);border-radius:12px;
          padding:4px;border:1px solid var(--bd);margin-bottom:16px;}
    .tb{flex:1;padding:10px;background:none;border:none;color:var(--tx2);
        cursor:pointer;font-size:0.97rem;font-weight:600;border-radius:9px;transition:all .22s;}
    .tb.on{background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;}

    /* CARD */
    .card{background:var(--sf);border-radius:13px;padding:20px;
          border:1px solid var(--bd);margin-bottom:14px;}
    .ctit{font-size:0.97rem;font-weight:700;color:#a78bfa;
          margin-bottom:13px;display:flex;align-items:center;gap:7px;}

    /* UPLOAD */
    .dropz{border:2px dashed rgba(120,80,255,0.35);border-radius:11px;
           padding:32px 18px;text-align:center;cursor:pointer;
           transition:all .28s;background:rgba(120,80,255,0.04);}
    .dropz:hover,.dropz.over{border-color:#7c3aed;background:rgba(120,80,255,0.09);}
    .dropz h3{color:var(--tx);margin-bottom:5px;font-size:0.98rem;}
    .dropz p{color:var(--tx2);font-size:0.8rem;}
    .dropz .ico{font-size:2.2rem;margin-bottom:7px;}
    input[type=file]{display:none;}
    .stbar{display:none;flex-direction:row;align-items:center;gap:11px;
           margin-top:11px;background:rgba(120,80,255,0.1);
           border-radius:8px;padding:9px 13px;font-size:0.87rem;}
    .spin{width:15px;height:15px;border:3px solid rgba(120,80,255,0.3);
          border-top:3px solid #7c3aed;border-radius:50%;
          animation:spin 1s linear infinite;flex-shrink:0;}
    @keyframes spin{to{transform:rotate(360deg);}}

    /* OP SELECTOR */
    .ops{display:none;margin-bottom:14px;}
    .ops-t{color:var(--tx2);font-size:0.86rem;margin-bottom:9px;text-align:center;}
    .op-btns{display:flex;gap:11px;}
    .ob{flex:1;padding:15px 9px 11px;border-radius:13px;border:2px solid transparent;
        cursor:pointer;transition:all .22s;background:var(--sf2);
        text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;}
    .ob:hover{transform:translateY(-2px);}
    .ob .nm{font-size:0.93rem;font-weight:700;color:var(--tx2);}
    .ob .sub{font-size:0.69rem;color:var(--tx2);line-height:1.5;}
    .ob.wt{border-color:rgba(224,112,32,0.22);}
    .ob.wt.sel,.ob.wt:hover{background:rgba(224,112,32,0.11);border-color:var(--wt);}
    .ob.wt.sel .nm,.ob.wt:hover .nm{color:#fdba74;}
    .ob.opt{border-color:rgba(14,165,233,0.22);}
    .ob.opt.sel,.ob.opt:hover{background:rgba(14,165,233,0.11);border-color:var(--opt);}
    .ob.opt.sel .nm,.ob.opt:hover .nm{color:#7dd3fc;}

    /* WT TOGGLE */
    .wttog{display:none;background:rgba(224,112,32,0.07);
           border:1px solid rgba(224,112,32,0.27);border-radius:11px;
           padding:14px 16px;margin-bottom:14px;}
    .wttog-t{font-size:0.88rem;font-weight:600;color:#fdba74;margin-bottom:10px;}
    .wt-bs{display:flex;gap:10px;}
    .wtsb{flex:1;padding:10px 8px;border-radius:9px;border:2px solid transparent;
          cursor:pointer;font-size:0.86rem;font-weight:700;transition:all .2s;
          background:var(--sf2);color:var(--tx2);text-align:center;}
    .wtsb small{font-size:0.69rem;color:var(--tx2);display:block;margin-top:2px;}
    .wtsb.y.sel,.wtsb.y:hover{background:rgba(224,112,32,0.17);border-color:var(--wt);color:#fdba74;}
    .wtsb.n.sel,.wtsb.n:hover{background:rgba(148,163,184,0.09);border-color:#94a3b8;color:var(--tx);}

    /* MESSAGGI */
    .msg{border-radius:8px;padding:10px 13px;margin-bottom:13px;
         display:none;font-weight:500;font-size:0.88rem;}
    .msg.err{background:rgba(239,68,68,0.09);border:1.5px solid var(--er);color:var(--er);}
    .msg.ok{background:rgba(34,197,94,0.09);border:1.5px solid var(--ok);color:var(--ok);}

    /* RESULTS */
    .res{display:none;}

    /* HERO */
    .hero{border-radius:13px;padding:24px 18px;text-align:center;
          margin-bottom:13px;border:2px solid;}
    .hero.sav{background:linear-gradient(135deg,rgba(34,197,94,0.09),rgba(34,197,94,0.02));border-color:rgba(34,197,94,0.28);}
    .hero.los{background:linear-gradient(135deg,rgba(239,68,68,0.09),rgba(239,68,68,0.02));border-color:rgba(239,68,68,0.26);}
    .h-tag{font-size:0.7rem;text-transform:uppercase;letter-spacing:1.2px;color:var(--tx2);margin-bottom:3px;}
    .h-big{font-size:2.9rem;font-weight:900;line-height:1;}
    .h-big.g{color:var(--ok);}
    .h-big.r{color:var(--er);}
    .h-sub{font-size:0.81rem;color:var(--tx2);margin-top:5px;}
    .h-sub strong{color:var(--tx);}
    .pill{display:inline-block;padding:4px 15px;border-radius:20px;
          font-weight:800;font-size:0.93rem;margin-top:9px;}
    .pill.g{background:rgba(34,197,94,0.13);color:var(--ok);border:1.5px solid rgba(34,197,94,0.23);}
    .pill.r{background:rgba(239,68,68,0.11);color:var(--er);border:1.5px solid rgba(239,68,68,0.23);}

    /* GRID CARDS */
    .ng{display:grid;grid-template-columns:1fr 1fr;gap:11px;margin-bottom:13px;}
    @media(max-width:480px){.ng{grid-template-columns:1fr;}}
    .nc{background:var(--sf2);border-radius:11px;padding:15px;border:1.5px solid var(--bd);}
    .nc.cr{border-color:rgba(239,68,68,0.2);}
    .nc.nw{border-color:rgba(224,112,32,0.28);}
    .nc.no{border-color:rgba(14,165,233,0.28);}
    .nc-l{font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--tx2);margin-bottom:2px;}
    .nc-o{font-size:0.7rem;color:var(--tx2);font-style:italic;margin-bottom:4px;}
    .nc-v{font-size:1.6rem;font-weight:800;}
    .nc-v.r{color:#f87171;}
    .nc-v.or{color:#fdba74;}
    .nc-v.bl{color:#7dd3fc;}
    .nc-u{font-size:0.71rem;color:var(--tx2);margin-top:2px;}

    /* GRAFICI */
    .ch-row{display:grid;grid-template-columns:1fr 1fr;gap:13px;margin-bottom:13px;}
    @media(max-width:540px){.ch-row{grid-template-columns:1fr;}}
    .chc{background:var(--sf);border:1px solid var(--bd);border-radius:13px;padding:16px;}
    .chc h3{color:#a78bfa;margin-bottom:11px;font-size:0.86rem;text-align:center;}
    .chw{position:relative;max-width:185px;margin:0 auto 9px;}
    .chcen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;}
    .chcen .cb{font-size:1.45rem;font-weight:900;}
    .chcen .cb.g{color:var(--ok);}
    .chcen .cb.r{color:var(--er);}
    .chcen .cs{font-size:0.68rem;color:var(--tx2);}
    .chl{display:flex;justify-content:center;gap:11px;font-size:0.73rem;color:var(--tx2);flex-wrap:wrap;}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:3px;vertical-align:middle;}

    /* DETTAGLIO */
    .ds{margin-bottom:11px;}
    .ds-t{font-size:0.69rem;text-transform:uppercase;letter-spacing:1px;color:var(--tx2);
          margin-bottom:6px;padding-bottom:3px;border-bottom:1px solid rgba(255,255,255,0.05);}
    .dr{display:flex;justify-content:space-between;padding:4px 0;
        border-bottom:1px solid rgba(255,255,255,0.04);font-size:0.83rem;}
    .dr:last-child{border-bottom:none;}
    .dl{color:var(--tx2);}
    .dv{font-weight:600;}
    .dv.g{color:var(--ok);}
    .dv.r{color:#f87171;}
    .dv.or{color:#fdba74;}
    .dv.bl{color:#7dd3fc;}
    .tr{border-radius:7px;padding:7px 10px;margin-top:5px;
        display:flex;justify-content:space-between;font-weight:700;font-size:0.88rem;}
    .tr.c{background:rgba(239,68,68,0.07);}
    .tr.w{background:rgba(224,112,32,0.09);}
    .tr.o{background:rgba(14,165,233,0.09);}

    /* QF BOX */
    .qfbox{background:rgba(120,80,255,0.06);border:1px solid rgba(120,80,255,0.2);
           border-radius:10px;padding:12px 15px;margin-bottom:13px;}
    .qfbox-t{font-size:0.72rem;text-transform:uppercase;letter-spacing:1px;
             color:#a78bfa;margin-bottom:8px;}

    /* INFO OFFERTA */
    .oi{border-radius:9px;padding:11px 14px;margin-bottom:13px;font-size:0.81rem;}
    .oi.w{background:rgba(224,112,32,0.06);border:1px solid rgba(224,112,32,0.2);}
    .oi.o{background:rgba(14,165,233,0.06);border:1px solid rgba(14,165,233,0.2);}
    .oi-t{font-weight:700;margin-bottom:6px;font-size:0.9rem;}
    .oi-r{display:flex;gap:13px;flex-wrap:wrap;}
    .oi-i{color:var(--tx2);}
    .oi-i b.or{color:#fdba74;}
    .oi-i b.bl{color:#7dd3fc;}

    /* BADGE */
    .br{color:var(--ok);font-size:0.68rem;margin-left:5px;}
    .bs{color:#f59e0b;font-size:0.68rem;margin-left:5px;}

    /* CHIPS */
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;}
    .chip{background:rgba(120,80,255,0.09);border:1px solid var(--bd);
          border-radius:7px;padding:5px 11px;font-size:0.77rem;}
    .chip b{color:#a78bfa;display:block;font-size:0.91rem;}
  </style>
</head>
<body>
<div class="wrap">

  <!-- HEADER -->
  <div class="header">
    <div class="logo">‚ö° Preventivo Energia PRO</div>
    <p>Carica la bolletta del cliente ‚Äî confronto WindTre / Optima</p>
  </div>

  <!-- INDICI (solo qui) -->
  <div class="indici">
    <div class="ic">üí° PUN GME: <b id="punV">0,13266</b> ‚Ç¨/kWh <span class="ic-tag" id="punM">Gen 2026</span></div>
    <div class="ic">üî• PSV: <b id="psvV">0,40423</b> ‚Ç¨/Smc <span class="ic-tag" id="psvM">Gen 2026</span></div>
    <div class="ic-note">Media mensile ufficiale GME ¬∑ aggiornata mensilmente</div>
  </div>

  <div class="msg err" id="mErr"></div>
  <div class="msg ok"  id="mOk"></div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tb on" onclick="sTab('luce',event)">üí° LUCE</button>
    <button class="tb"    onclick="sTab('gas',event)">üî• GAS</button>
  </div>

  <!-- TAB LUCE -->
  <div id="tl">
    <div class="card">
      <div class="ctit">üìÑ Bolletta LUCE (PDF)</div>
      <div class="dropz" id="dL" ondrop="onDrop(event,'l')"
           ondragover="onOv(event,'l')" ondragleave="onLv(event,'l')"
           onclick="document.getElementById('fL').click()">
        <div class="ico">üìã</div>
        <h3>Trascina il PDF oppure clicca</h3>
        <p>Tutti gli operatori (IREN, Enel, ENI, A2A‚Ä¶) ¬∑ Max 10 MB</p>
      </div>
      <input type="file" id="fL" accept=".pdf" onchange="onFile(event,'l')">
      <div class="stbar" id="sbL"><div class="spin"></div><span id="stL">Analisi...</span></div>
    </div>
    <div class="ops" id="opsL">
      <div class="ops-t">Scegli operatore per il preventivo:</div>
      <div class="op-btns">
        <div class="ob wt" id="obWL" onclick="selOp('l','wt')">
          <span style="font-size:1.4rem">üåÄ</span>
          <span class="nm">WindTre</span>
          <span class="sub">PUN + 0,0278 ‚Ç¨/kWh<br>Fisso 90‚Äì156 ‚Ç¨/anno</span>
        </div>
        <div class="ob opt" id="obOL" onclick="selOp('l','opt')">
          <span style="font-size:1.4rem">üîµ</span>
          <span class="nm">Optima</span>
          <span class="sub">PUN + 0,0396 ‚Ç¨/kWh<br>Fisso 154,80 ‚Ç¨/anno</span>
        </div>
      </div>
    </div>
    <div class="wttog" id="wtL">
      <div class="wttog-t">üåÄ Il cliente √® gi√† cliente WindTre?</div>
      <div class="wt-bs">
        <div class="wtsb y" id="wtYL" onclick="selWt('l',true)">‚úÖ S√¨ ‚Äî Cliente WindTre<small>Fisso 90 ‚Ç¨/anno</small></div>
        <div class="wtsb n" id="wtNL" onclick="selWt('l',false)">‚ùå No ‚Äî Non √® cliente<small>Fisso 156 ‚Ç¨/anno</small></div>
      </div>
    </div>
    <div class="res" id="rL"></div>
  </div>

  <!-- TAB GAS -->
  <div id="tg" style="display:none">
    <div class="card">
      <div class="ctit">üìÑ Bolletta GAS (PDF)</div>
      <div class="dropz" id="dG" ondrop="onDrop(event,'g')"
           ondragover="onOv(event,'g')" ondragleave="onLv(event,'g')"
           onclick="document.getElementById('fG').click()">
        <div class="ico">üìã</div>
        <h3>Trascina il PDF oppure clicca</h3>
        <p>Tutti gli operatori ¬∑ Max 10 MB</p>
      </div>
      <input type="file" id="fG" accept=".pdf" onchange="onFile(event,'g')">
      <div class="stbar" id="sbG"><div class="spin"></div><span id="stG">Analisi...</span></div>
    </div>
    <div class="ops" id="opsG">
      <div class="ops-t">Scegli operatore per il preventivo:</div>
      <div class="op-btns">
        <div class="ob wt" id="obWG" onclick="selOp('g','wt')">
          <span style="font-size:1.4rem">üåÄ</span>
          <span class="nm">WindTre</span>
          <span class="sub">PSV + 0,0965 ‚Ç¨/Smc<br>Fisso 90‚Äì156 ‚Ç¨/anno</span>
        </div>
        <div class="ob opt" id="obOG" onclick="selOp('g','opt')">
          <span style="font-size:1.4rem">üîµ</span>
          <span class="nm">Optima</span>
          <span class="sub">PSV + 0,12 ‚Ç¨/Smc<br>Fisso 162 ‚Ç¨/anno</span>
        </div>
      </div>
    </div>
    <div class="wttog" id="wtG">
      <div class="wttog-t">üåÄ Il cliente √® gi√† cliente WindTre?</div>
      <div class="wt-bs">
        <div class="wtsb y" id="wtYG" onclick="selWt('g',true)">‚úÖ S√¨ ‚Äî Cliente WindTre<small>Fisso 90 ‚Ç¨/anno</small></div>
        <div class="wtsb n" id="wtNG" onclick="selWt('g',false)">‚ùå No ‚Äî Non √® cliente<small>Fisso 156 ‚Ç¨/anno</small></div>
      </div>
    </div>
    <div class="res" id="rG"></div>
  </div>

</div><!-- /wrap -->

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚îÄ‚îÄ INDICI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IND = { pun: 0.132660, psv: 0.404227, mese: 'Gen 2026' };
(async()=>{
  try{
    const r=await fetch('/api/indici',{signal:AbortSignal.timeout(3000)});
    if(r.ok){const d=await r.json();if(d.pun)IND.pun=d.pun;if(d.psv)IND.psv=d.psv;if(d.mese)IND.mese=d.mese;}
  }catch(e){}
  document.getElementById('punV').textContent=IND.pun.toFixed(5);
  document.getElementById('psvV').textContent=IND.psv.toFixed(5);
  document.getElementById('punM').textContent=IND.mese;
  document.getElementById('psvM').textContent=IND.mese;
})();

// ‚îÄ‚îÄ TARIFFE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAR={
  l:{ get idx(){return IND.pun;}, iva:0.10,
      wt:{sp:0.0278,vc:0.0154,fWT:90.00,fNO:156.00},
      opt:{sp:0.0396,vc:0.0154,f:154.80} },
  g:{ get idx(){return IND.psv;}, iva:0.22,
      wt:{sp:0.0965,vc:0,fWT:90.00,fNO:156.00},
      opt:{sp:0.12,vc:0.11,f:162.00} }
};

// ‚îÄ‚îÄ STATO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BD={l:null,g:null};          // bolletta data
const SOP={l:null,g:null};         // operatore selezionato
const SWT={l:null,g:null};         // cliente windtre
const CH={lP:null,lA:null,gP:null,gA:null};

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sTab(t,e){
  document.getElementById('tl').style.display=t==='luce'?'block':'none';
  document.getElementById('tg').style.display=t==='gas'?'block':'none';
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
  e.target.classList.add('on');
}
function onOv(e,t){e.preventDefault();document.getElementById('d'+t.toUpperCase()).classList.add('over');}
function onLv(e,t){e.preventDefault();document.getElementById('d'+t.toUpperCase()).classList.remove('over');}
function onDrop(e,t){e.preventDefault();onLv(e,t);const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')proc(f,t);else showErr('Carica un PDF valido.');}
function onFile(e,t){if(e.target.files[0])proc(e.target.files[0],t);}
const T=t=>t.toUpperCase();

// ‚îÄ‚îÄ LETTURA PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function proc(file,t){
  const sb=document.getElementById('sb'+T(t));
  const st=document.getElementById('st'+T(t));
  const tipo=t==='l'?'luce':'gas';
  sb.style.display='flex';
  document.getElementById('r'+T(t)).style.display='none';
  document.getElementById('ops'+T(t)).style.display='none';
  document.getElementById('wt'+T(t)).style.display='none';
  resetOb(t);
  st.textContent='Lettura PDF...';
  try{
    if(file.size>10485760){showErr('File troppo grande (max 10 MB)');sb.style.display='none';return;}
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    st.textContent='Analisi '+pdf.numPages+' pagine...';
    let txt='';
    for(let p=1;p<=pdf.numPages;p++){
      const pg=await pdf.getPage(p);
      const c=await pg.getTextContent();
      txt+=c.items.map(i=>i.str).join(' ')+'\n';
    }
    st.textContent='Estrazione dati...';
    const resp=await fetch('/api/estrai-bolletta?tipo='+tipo,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({text:txt})
    });
    const data=await resp.json();
    if(!data.success){showErr('‚ö†Ô∏è '+(data.error||'Dati non trovati.'));sb.style.display='none';return;}
    sb.style.display='none';

    BD[t]={
      operatore:    data.operatore||'Operatore attuale',
      consumoAnn:   data.consumoAnnuo,
      spesaAnn:     data.spesaAnnua,
      consumoPer:   data.consumoPeriodo,
      spesaPer:     data.spesaPeriodo,
      mesi:         data.mesi||2,
      qfAnn:        data.quotaFissaAnnua||null,   // quota fissa annuale cliente
      fonte:        data.quotaFissaAnnua?'reale':'stimata'
    };

    document.getElementById('ops'+T(t)).style.display='block';
    const ua=t==='l'?'kWh':'Smc';
    showOk(
      '‚úÖ '+BD[t].operatore+
      ' ¬∑ '+BD[t].consumoAnn.toFixed(0)+' '+ua+'/anno'+
      ' ¬∑ ‚Ç¨ '+BD[t].spesaAnn.toFixed(2)+'/anno'+
      (BD[t].qfAnn?' ¬∑ Q.fissa ‚Ç¨ '+BD[t].qfAnn.toFixed(2)+'/anno':'')+
      ' ‚Äî Scegli operatore'
    );
  }catch(err){console.error(err);showErr('Errore: '+err.message);sb.style.display='none';}
}

// ‚îÄ‚îÄ SELEZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selOp(t,op){
  resetOb(t);
  document.getElementById('ob'+op.toUpperCase()[0]+T(t)).classList.add('sel');
  SOP[t]=op;
  document.getElementById('wt'+T(t)).style.display=op==='wt'?'block':'none';
  document.getElementById('r'+T(t)).style.display='none';
  if(op!=='wt'){SWT[t]=null;calc(t,op);}
}
function resetOb(t){
  ['W','O'].forEach(o=>document.getElementById('ob'+o+T(t)).classList.remove('sel'));
  ['Y','N'].forEach(n=>{const el=document.getElementById('wt'+n+T(t));if(el)el.classList.remove('sel');});
}
function selWt(t,v){
  SWT[t]=v;
  document.getElementById('wtY'+T(t)).classList.toggle('sel',v);
  document.getElementById('wtN'+T(t)).classList.toggle('sel',!v);
  calc(t,'wt');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚ïê‚ïê  CALCOLO ‚Äî BASE ANNUALE PURA  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//
//  FONTE DATI: "Spesa annua sostenuta" + "Consumo annuo kWh"
//  presenti in tutte le bollette (obbligatori ARERA).
//
//  STRUTTURA COSTO ANNUALE CLIENTE ATTUALE:
//    SpesaAnn = MateriaVarAnn + QuotaFissaClienteAnn
//             + ReteOneriAnn (ARERA, invariata)
//             + ImposteAnn   (ARERA, invariata)
//
//  STRUTTURA COSTO ANNUALE NOSTRA OFFERTA:
//    CostoNosAnn = (Indice + Spread + VarCons) √ó IVA √ó ConsumoAnn
//               + FissoNosAnn
//               + ReteOneriAnn  ‚Üê IDENTICA (stesso distributore)
//               + ImposteAnn    ‚Üê IDENTICA
//
//  Risparmio = SpesaAnn ‚àí CostoNosAnn
//
//  Componenti ARERA stimate con proporzioni validate:
//    LUCE: imposte ‚âà 11.3%, rete ‚âà 23%, oneri ‚âà 21.5%
//    GAS:  imposte ‚âà 19.5%, rete ‚âà 23.7%, oneri ‚âà 7.5%
//
//  Quota fissa cliente:
//    Se estratta dall'API ‚Üí usa quella (badge ‚úÖ)
//    Altrimenti ‚Üí stimata come % della spesa annua (badge ‚ö†Ô∏è)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function calc(t,op){
  const d=BD[t]; if(!d) return;
  const tipo=t==='l'?'luce':'gas';
  const T2=TAR[t]; const O=T2[op];
  const ua=t==='l'?'kWh':'Smc';
  const isWt=op==='wt';
  const opN=isWt?'WindTre':'Optima';
  const opC=isWt?'or':'bl';
  const isWtCl=isWt&&SWT[t]===true;
  const fissoNos=isWt?(isWtCl?O.fWT:O.fNO):O.f;

  // ‚îÄ‚îÄ Prezzo unitario nostra offerta ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const pzNetto = T2.idx + O.sp + (O.vc||0);
  const pzLordo = pzNetto * (1 + T2.iva);

  // ‚îÄ‚îÄ Costi annuali cliente ATTUALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const spesaAnn   = d.spesaAnn;
  const consumoAnn = d.consumoAnn;

  // Componenti ARERA annuali (invariate)
  let reteAnn, oneriAnn, impoAnn;
  if (tipo==='luce') {
    impoAnn  = spesaAnn * 0.113;
    const b  = spesaAnn - impoAnn;
    reteAnn  = b * 0.373;   // ~23% del totale lordo
    oneriAnn = b * 0.348;   // ~21.5%
  } else {
    impoAnn  = spesaAnn * 0.195;
    const b  = spesaAnn - impoAnn;
    reteAnn  = b * 0.295;
    oneriAnn = b * 0.093;
  }
  const fisseAnn = reteAnn + oneriAnn + impoAnn;

  // Quota fissa annuale cliente
  const qfAnnCl = d.qfAnn !== null
    ? d.qfAnn
    : parseFloat((tipo==='luce' ? spesaAnn*0.22 : spesaAnn*0.14).toFixed(2));
  const qfFonte = d.qfAnn !== null ? 'reale' : 'stimata';

  // Materia variabile annuale attuale (solo parte variabile, senza quota fissa)
  const matVarAnn = parseFloat((spesaAnn - fisseAnn - qfAnnCl).toFixed(2));

  // ‚îÄ‚îÄ Nostra offerta ‚Äî annuale ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const enNosAnn  = parseFloat((pzLordo * consumoAnn).toFixed(2));  // solo energia variabile
  const matNosAnn = parseFloat((enNosAnn + fissoNos).toFixed(2));   // + quota fissa nostra
  const costoNosAnn = parseFloat((matNosAnn + fisseAnn).toFixed(2));

  // ‚îÄ‚îÄ Nostra offerta ‚Äî periodo (solo per info) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const mesi     = d.mesi;
  const f        = mesi/12;                                         // frazione anno
  const spesaPer = d.spesaPer || parseFloat((spesaAnn*f).toFixed(2));
  const cNoPer   = parseFloat((costoNosAnn*f).toFixed(2));

  // ‚îÄ‚îÄ Risparmi ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const rispAnn  = parseFloat((spesaAnn - costoNosAnn).toFixed(2));
  const rispPer  = parseFloat((spesaPer - cNoPer).toFixed(2));
  const percAnn  = parseFloat((rispAnn / spesaAnn * 100).toFixed(1));
  const rispQF   = parseFloat((qfAnnCl - fissoNos).toFixed(2));     // solo fisso
  const rispVar  = parseFloat((matVarAnn - enNosAnn).toFixed(2));   // solo variabile
  const isSav    = rispAnn >= 0;

  const indN = t==='l'?'PUN Index GME':'PSV';
  const qfBadge = qfFonte==='reale'
    ? '<span class="br">‚úÖ reale</span>'
    : '<span class="bs">‚ö†Ô∏è stimata</span>';

  document.getElementById('r'+T(t)).innerHTML = `

    <!-- CHIPS INFO -->
    <div class="chips">
      <div class="chip"><b>${consumoAnn.toFixed(0)}</b>${ua}/anno</div>
      <div class="chip"><b>${d.operatore}</b>operatore att.</div>
      <div class="chip"><b>‚Ç¨ ${spesaAnn.toFixed(2)}</b>/anno att.</div>
      <div class="chip"><b>${mesi}</b>${mesi===1?'mese':'mesi'} boll.</div>
      <div class="chip" style="${qfFonte==='reale'?'border-color:rgba(34,197,94,0.3)':'border-color:rgba(245,158,11,0.3)'}">
        Q.fissa ${qfBadge}
      </div>
    </div>

    <!-- INFO OFFERTA -->
    <div class="oi ${isWt?'w':'o'}">
      <div class="oi-t" style="color:${isWt?'#fdba74':'#7dd3fc'}">
        ${isWt?'üåÄ':'üîµ'} ${opN}${isWtCl?' ¬∑ Cliente WindTre ‚úÖ':''}
      </div>
      <div class="oi-r">
        <div class="oi-i">${indN}: <b class="${opC}">${T2.idx.toFixed(5)} ‚Ç¨/${ua}</b></div>
        <div class="oi-i">Spread: <b class="${opC}">+${O.sp} ‚Ç¨/${ua}</b></div>
        ${O.vc?`<div class="oi-i">Comm.var.: <b class="${opC}">+${O.vc} ‚Ç¨/${ua}</b></div>`:''}
        <div class="oi-i">Prezzo IVA incl.: <b class="${opC}">${pzLordo.toFixed(5)} ‚Ç¨/${ua}</b></div>
        <div class="oi-i">Fisso annuo: <b class="${opC}">‚Ç¨ ${fissoNos.toFixed(2)}${isWtCl?' üè∑Ô∏è':''}</b></div>
      </div>
    </div>

    <!-- BOX QUOTA FISSA -->
    <div class="qfbox">
      <div class="qfbox-t">üìå Confronto quota fissa annuale</div>
      <div class="dr"><span class="dl">${d.operatore} ${qfBadge}</span>
        <span class="dv r">‚Ç¨ ${qfAnnCl.toFixed(2)}/anno</span></div>
      <div class="dr"><span class="dl">${opN}</span>
        <span class="dv ${opC}">‚Ç¨ ${fissoNos.toFixed(2)}/anno</span></div>
      <div class="dr" style="margin-top:4px;padding-top:6px;border-top:1px solid rgba(255,255,255,0.06)">
        <span class="dl">Risparmio solo quota fissa</span>
        <span class="dv ${rispQF>=0?'g':'r'}" style="font-size:0.95rem;font-weight:800">
          ${rispQF>=0?'‚àí ‚Ç¨ ':'+ ‚Ç¨ '}${Math.abs(rispQF).toFixed(2)}/anno
        </span>
      </div>
    </div>

    <!-- HERO -->
    <div class="hero ${isSav?'sav':'los'}">
      <div class="h-tag">Risparmio stimato su 12 mesi</div>
      <div class="h-big ${isSav?'g':'r'}">${isSav?'':'‚àí '}‚Ç¨ ${Math.abs(rispAnn).toFixed(2)}</div>
      <div class="h-sub">
        Con <strong>${d.operatore}</strong>: ‚Ç¨ ${spesaAnn.toFixed(2)}/anno
        &rarr; Con <strong>${opN}</strong>: ‚Ç¨ ${costoNosAnn.toFixed(2)}/anno
      </div>
      <div class="pill ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percAnn)}% annuo</div>
      <div style="margin-top:11px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.06);
                  font-size:0.8rem;color:var(--tx2);text-align:center">
        Stima periodo (${mesi} ${mesi===1?'mese':'mesi'}):
        <strong>${d.operatore} ‚Ç¨ ${spesaPer.toFixed(2)}</strong> ‚Üí
        <strong>${opN} ‚Ç¨ ${cNoPer.toFixed(2)}</strong>
        ¬∑ Risp. <strong style="color:${rispPer>=0?'var(--ok)':'var(--er)'}">
          ${rispPer>=0?'‚àí ‚Ç¨ ':'+ ‚Ç¨ '}${Math.abs(rispPer).toFixed(2)}</strong>
      </div>
    </div>

    <!-- GRID NUMERICA -->
    <div class="ng">
      <div class="nc cr">
        <div class="nc-l">Paga ora con</div>
        <div class="nc-o">${d.operatore}</div>
        <div class="nc-v r">‚Ç¨ ${spesaAnn.toFixed(2)}</div>
        <div class="nc-u">/ anno</div>
      </div>
      <div class="nc ${isWt?'nw':'no'}">
        <div class="nc-l">Con ${opN} pagherebbe</div>
        <div class="nc-o">${opN}${isWtCl?' ‚úÖ':''}</div>
        <div class="nc-v ${opC}">‚Ç¨ ${costoNosAnn.toFixed(2)}</div>
        <div class="nc-u">/ anno</div>
      </div>
    </div>

    <!-- DUE GRAFICI -->
    <div class="ch-row">
      <div class="chc">
        <h3>üìã Periodo (${mesi} ${mesi===1?'mese':'mesi'})</h3>
        <div class="chw">
          <canvas id="cP${t}" width="185" height="185"></canvas>
          <div class="chcen">
            <div class="cb ${rispPer>=0?'g':'r'}">
              ${rispPer>=0?'‚àí':'+'}${Math.abs(parseFloat((rispPer/spesaPer*100).toFixed(1)))}%
            </div>
            <div class="cs">${rispPer>=0?'risparmio':'extra'}</div>
          </div>
        </div>
        <div class="chl">
          <span><span class="dot" style="background:${isWt?'#e07020':'#0ea5e9'}"></span>${opN} ‚Ç¨ ${cNoPer.toFixed(2)}</span>
          <span><span class="dot" style="background:${rispPer>=0?'#22c55e':'#ef4444'}"></span>${rispPer>=0?'Risp.':'Extra'} ‚Ç¨ ${Math.abs(rispPer).toFixed(2)}</span>
        </div>
      </div>
      <div class="chc">
        <h3>üìÖ Annuale (12 mesi)</h3>
        <div class="chw">
          <canvas id="cA${t}" width="185" height="185"></canvas>
          <div class="chcen">
            <div class="cb ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percAnn)}%</div>
            <div class="cs">${isSav?'risparmio':'extra'}</div>
          </div>
        </div>
        <div class="chl">
          <span><span class="dot" style="background:${isWt?'#e07020':'#0ea5e9'}"></span>${opN} ‚Ç¨ ${costoNosAnn.toFixed(2)}</span>
          <span><span class="dot" style="background:${isSav?'#22c55e':'#ef4444'}"></span>${isSav?'Risp.':'Extra'} ‚Ç¨ ${Math.abs(rispAnn).toFixed(2)}</span>
        </div>
      </div>
    </div>

    <!-- DETTAGLIO CALCOLO -->
    <div class="card">
      <div class="ctit">üîç Dettaglio calcolo annuale</div>

      <div class="ds">
        <div class="ds-t">üìå ${d.operatore} ‚Äî spesa annuale (fonte bolletta ARERA)</div>
        <div class="dr"><span class="dl">Consumo annuo</span><span class="dv">${consumoAnn.toFixed(0)} ${ua}/anno</span></div>
        <div class="dr"><span class="dl">Materia variabile (vendita)</span><span class="dv r">‚Ç¨ ${matVarAnn.toFixed(2)}/anno</span></div>
        <div class="dr">
          <span class="dl">Quota fissa cliente${qfBadge}</span>
          <span class="dv r">‚Ç¨ ${qfAnnCl.toFixed(2)}/anno</span>
        </div>
        <div class="dr"><span class="dl">Rete + distribuzione + misura</span><span class="dv">‚Ç¨ ${reteAnn.toFixed(2)}/anno</span></div>
        <div class="dr"><span class="dl">Oneri di sistema</span><span class="dv">‚Ç¨ ${oneriAnn.toFixed(2)}/anno</span></div>
        <div class="dr"><span class="dl">Imposte (accise + IVA)</span><span class="dv">‚Ç¨ ${impoAnn.toFixed(2)}/anno</span></div>
        <div class="tr c">
          <span style="color:var(--tx2)">Totale annuo ${d.operatore}</span>
          <span class="dv r">‚Ç¨ ${spesaAnn.toFixed(2)}</span>
        </div>
      </div>

      <div class="ds">
        <div class="ds-t">${isWt?'üåÄ':'üîµ'} ${opN}${isWtCl?' ¬∑ Cliente WindTre ‚úÖ':''}</div>
        <div class="dr">
          <span class="dl">${indN} + spread + comm. var.</span>
          <span class="dv ${opC}">${pzLordo.toFixed(5)} ‚Ç¨/${ua} (IVA incl.)</span>
        </div>
        <div class="dr">
          <span class="dl">Energia: ${consumoAnn.toFixed(0)} ${ua} √ó ${pzLordo.toFixed(5)}</span>
          <span class="dv">‚Ç¨ ${enNosAnn.toFixed(2)}/anno</span>
        </div>
        <div class="dr">
          <span class="dl">Quota fissa annua ${opN}${isWtCl?' üè∑Ô∏è':''}</span>
          <span class="dv ${opC}">‚Ç¨ ${fissoNos.toFixed(2)}/anno</span>
        </div>
        <div class="dr">
          <span class="dl">Rete + oneri + imposte (invariate)</span>
          <span class="dv">‚Ç¨ ${fisseAnn.toFixed(2)}/anno</span>
        </div>
        <div class="tr ${isWt?'w':'o'}">
          <span style="color:var(--tx2)">Totale annuo ${opN}</span>
          <span style="color:${isWt?'#fdba74':'#7dd3fc'}">‚Ç¨ ${costoNosAnn.toFixed(2)}</span>
        </div>
      </div>

      <div class="ds">
        <div class="ds-t">‚úÖ Risultato finale</div>
        <div class="dr">
          <span class="dl">Risparmio quota fissa</span>
          <span class="dv ${rispQF>=0?'g':'r'}">
            ${rispQF>=0?'‚àí ‚Ç¨ ':'+ ‚Ç¨ '}${Math.abs(rispQF).toFixed(2)}/anno
          </span>
        </div>
        <div class="dr">
          <span class="dl">Risparmio materia variabile</span>
          <span class="dv ${rispVar>=0?'g':'r'}">
            ${rispVar>=0?'‚àí ‚Ç¨ ':'+ ‚Ç¨ '}${Math.abs(rispVar).toFixed(2)}/anno
          </span>
        </div>
        <div class="dr" style="font-size:0.95rem;padding:7px 0">
          <span class="dl" style="font-weight:700;color:var(--tx)">Risparmio TOTALE annuale</span>
          <span class="dv ${isSav?'g':'r'}" style="font-size:1.05rem">
            ${isSav?'‚àí ‚Ç¨ ':'+ ‚Ç¨ '}${Math.abs(rispAnn).toFixed(2)}/anno
          </span>
        </div>
        <div class="dr">
          <span class="dl">Variazione %</span>
          <span class="dv ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percAnn)}%</span>
        </div>
        ${isWtCl?`<div class="dr"><span class="dl">Di cui sconto cliente WindTre</span><span class="dv g">‚àí ‚Ç¨ 66,00/anno</span></div>`:''}
      </div>
    </div>
  `;

  document.getElementById('r'+T(t)).style.display='block';
  renderCh(t,op,cNoPer,rispPer,costoNosAnn,rispAnn,isSav,spesaPer);
  window.scrollTo({top:document.getElementById('r'+T(t)).offsetTop-20,behavior:'smooth'});
}

// ‚îÄ‚îÄ GRAFICI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderCh(t,op,cNoPer,rispPer,cNoAnn,rispAnn,isSav,spesaPer){
  ['P','A'].forEach(k=>{if(CH[t+k])CH[t+k].destroy();});
  const cO=op==='wt'?'rgba(224,112,32,0.85)':'rgba(14,165,233,0.85)';
  function mk(id,val,diff){
    const ctx=document.getElementById(id);
    if(!ctx) return null;
    return new Chart(ctx.getContext('2d'),{
      type:'doughnut',
      data:{datasets:[{
        data:[val,Math.max(Math.abs(diff),0.01)],
        backgroundColor:[cO,diff>=0?'rgba(34,197,94,0.82)':'rgba(239,68,68,0.75)'],
        borderColor:'#0a0a14',borderWidth:3,hoverOffset:6
      }]},
      options:{cutout:'66%',animation:{duration:900},
        plugins:{legend:{display:false},
          tooltip:{callbacks:{label:c=>' ‚Ç¨ '+c.parsed.toFixed(2)}}}}
    });
  }
  CH[t+'P']=mk('cP'+t,cNoPer,rispPer);
  CH[t+'A']=mk('cA'+t,cNoAnn,rispAnn);
}

// ‚îÄ‚îÄ MESSAGGI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showErr(m){const e=document.getElementById('mErr');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',7000);}
function showOk(m){const e=document.getElementById('mOk');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',7000);}
</script>
</body>
</html>

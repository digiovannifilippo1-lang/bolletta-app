<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preventivo WindTre Energia</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary: #7c3aed;
      --primary-light: #a78bfa;
      --success: #22c55e;
      --error: #ef4444;
      --bg: #0f0f1a;
      --surface: #1a1a2e;
      --surface2: #16213e;
      --text: #f1f5f9;
      --text2: #94a3b8;
      --border: rgba(124,58,237,0.25);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background:var(--bg); color:var(--text); padding:20px; min-height:100vh; }
    .container { max-width:900px; margin:0 auto; }

    /* Header */
    .header { text-align:center; margin-bottom:36px; padding:32px 20px; background:var(--surface); border-radius:16px; border:1px solid var(--border); }
    .logo { font-size:2.6rem; font-weight:900; background:linear-gradient(135deg,#7c3aed,#06b6d4); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text; margin-bottom:6px; }
    .header p { color:var(--text2); font-size:1rem; }
    .windtre-badge { display:inline-block; background:linear-gradient(135deg,#7c3aed,#4f46e5); color:#fff; font-size:0.8rem; font-weight:700; padding:4px 12px; border-radius:20px; margin-top:10px; letter-spacing:1px; }

    /* Offerta riepilogo */
    .offerta-box { background:var(--surface2); border:2px solid var(--border); border-radius:12px; padding:18px 22px; margin-bottom:28px; display:flex; flex-wrap:wrap; gap:16px; align-items:center; }
    .offerta-item { font-size:0.9rem; color:var(--text2); }
    .offerta-item strong { color:var(--primary-light); font-size:1.05rem; }
    .offerta-title { font-weight:700; color:var(--text); font-size:0.95rem; width:100%; margin-bottom:4px; }

    /* Upload */
    .upload-card { background:var(--surface); border-radius:14px; padding:28px; border:1px solid var(--border); margin-bottom:24px; }
    .upload-card h2 { font-size:1.15rem; color:var(--primary-light); margin-bottom:16px; display:flex; align-items:center; gap:8px; }
    .upload-area {
      border:2px dashed rgba(124,58,237,0.4); border-radius:12px; padding:44px 20px;
      text-align:center; cursor:pointer; transition:all 0.3s;
      background:rgba(124,58,237,0.04);
    }
    .upload-area:hover { border-color:var(--primary); background:rgba(124,58,237,0.1); }
    .upload-area.dragover { border-color:var(--success); background:rgba(34,197,94,0.08); }
    .upload-icon { font-size:2.8rem; margin-bottom:10px; }
    .upload-area h3 { color:var(--text); margin-bottom:6px; font-size:1.1rem; }
    .upload-area p { color:var(--text2); font-size:0.88rem; }
    .file-input { display:none; }

    /* Status */
    .status-bar { display:none; flex-direction:row; align-items:center; gap:12px; margin-top:16px; background:rgba(124,58,237,0.1); border-radius:8px; padding:12px 16px; }
    .spinner { width:18px; height:18px; border:3px solid rgba(124,58,237,0.3); border-top:3px solid var(--primary); border-radius:50%; animation:spin 1s linear infinite; flex-shrink:0; }
    @keyframes spin { to { transform:rotate(360deg); } }

    /* Messaggi */
    .msg { border-radius:8px; padding:13px 16px; margin-bottom:20px; display:none; font-weight:500; font-size:0.95rem; }
    .msg.error { background:rgba(239,68,68,0.12); border:2px solid var(--error); color:var(--error); }
    .msg.success { background:rgba(34,197,94,0.12); border:2px solid var(--success); color:var(--success); }

    /* Risultati */
    .results { display:none; }

    /* Hero risparmio */
    .hero-risparmio {
      background:linear-gradient(135deg,rgba(124,58,237,0.2),rgba(6,182,212,0.1));
      border:2px solid var(--primary); border-radius:16px; padding:30px 24px;
      text-align:center; margin-bottom:24px;
    }
    .hero-risparmio .label { color:var(--text2); font-size:0.9rem; text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; }
    .hero-risparmio .amount { font-size:3.2rem; font-weight:900; color:var(--success); line-height:1; }
    .hero-risparmio .amount.negative { color:var(--error); }
    .hero-risparmio .sub { color:var(--text2); margin-top:8px; font-size:1rem; }
    .hero-risparmio .perc-badge {
      display:inline-block; padding:6px 18px; border-radius:20px; font-weight:800;
      font-size:1.1rem; margin-top:12px;
    }
    .perc-badge.save { background:rgba(34,197,94,0.2); color:var(--success); border:2px solid rgba(34,197,94,0.4); }
    .perc-badge.lose { background:rgba(239,68,68,0.2); color:var(--error); border:2px solid rgba(239,68,68,0.4); }

    /* Griglia numeri */
    .numbers-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:24px; }
    @media (max-width:560px) { .numbers-grid { grid-template-columns:1fr; } }
    .num-card { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px; }
    .num-card.current { border-color:rgba(239,68,68,0.3); }
    .num-card.offer { border-color:rgba(124,58,237,0.5); }
    .nc-label { font-size:0.8rem; text-transform:uppercase; letter-spacing:1px; color:var(--text2); margin-bottom:6px; }
    .nc-operator { font-size:0.75rem; color:var(--text2); margin-bottom:4px; font-style:italic; }
    .nc-value { font-size:1.8rem; font-weight:800; }
    .nc-value.red { color:#f87171; }
    .nc-value.purple { color:var(--primary-light); }
    .nc-unit { font-size:0.82rem; color:var(--text2); margin-top:4px; }

    /* Grafico */
    .chart-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; margin-bottom:24px; }
    .chart-card h3 { color:var(--primary-light); margin-bottom:20px; font-size:1.05rem; }
    .chart-wrap { position:relative; max-width:280px; margin:0 auto 16px; }
    .chart-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; }
    .chart-center .c-perc { font-size:1.9rem; font-weight:900; }
    .chart-center .c-perc.green { color:var(--success); }
    .chart-center .c-perc.red { color:var(--error); }
    .chart-center .c-euro { font-size:0.82rem; color:var(--text2); }
    .chart-legend { display:flex; justify-content:center; gap:20px; font-size:0.85rem; color:var(--text2); flex-wrap:wrap; }
    .legend-dot { width:12px; height:12px; border-radius:50%; display:inline-block; margin-right:5px; vertical-align:middle; }

    /* Dettaglio */
    .detail-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; padding:24px; margin-bottom:24px; }
    .detail-card h3 { color:var(--primary-light); margin-bottom:16px; font-size:1.05rem; }
    .detail-section { margin-bottom:16px; }
    .detail-section-title { font-size:0.78rem; text-transform:uppercase; letter-spacing:1px; color:var(--text2); margin-bottom:8px; padding-bottom:4px; border-bottom:1px solid rgba(255,255,255,0.06); }
    .detail-row { display:flex; justify-content:space-between; padding:7px 0; border-bottom:1px solid rgba(255,255,255,0.04); font-size:0.9rem; }
    .detail-row:last-child { border-bottom:none; }
    .dr-label { color:var(--text2); }
    .dr-value { font-weight:600; }
    .dr-value.green { color:var(--success); }
    .dr-value.red { color:var(--error); }
    .dr-value.purple { color:var(--primary-light); }
    .total-row { background:rgba(124,58,237,0.15); border-radius:8px; padding:10px 12px; margin-top:8px; display:flex; justify-content:space-between; font-weight:700; font-size:1rem; }

    /* Nota bonus */
    .bonus-note { background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.3); border-radius:10px; padding:14px 16px; font-size:0.88rem; color:var(--text2); margin-bottom:24px; }
    .bonus-note strong { color:var(--success); }

    /* Consumi */
    .consumo-info { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:8px; }
    .ci-badge { background:rgba(124,58,237,0.15); border:1px solid var(--border); border-radius:8px; padding:8px 14px; font-size:0.85rem; }
    .ci-badge strong { color:var(--primary-light); display:block; font-size:1.1rem; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <div class="logo">‚ö° Preventivo Energia</div>
    <p>Carica la bolletta del cliente e confronta automaticamente con la nostra offerta</p>
    <div class="windtre-badge">üåÄ WINDTRE ENERGIA</div>
  </div>

  <!-- Riepilogo offerta -->
  <div class="offerta-box">
    <div class="offerta-title">üíú La tua offerta WindTre ‚Äî condizioni riservate clienti WindTre</div>
    <div class="offerta-item">‚ö° Prezzo energia: <strong>PUN Index GME + 0,0278 ‚Ç¨/kWh</strong></div>
    <div class="offerta-item">üìÖ Quota fissa: <strong>90 ‚Ç¨/anno</strong> (bloccata 24 mesi)</div>
    <div class="offerta-item">üéÅ Bonus: <strong>120 ‚Ç¨ (10‚Ç¨/mese per 12 mesi)</strong></div>
  </div>

  <div class="msg error" id="msgError"></div>
  <div class="msg success" id="msgSuccess"></div>

  <!-- Upload -->
  <div class="upload-card">
    <h2>üìÑ Carica Bolletta Cliente (PDF)</h2>
    <div class="upload-area" id="uploadArea"
      ondrop="handleDrop(event)"
      ondragover="e => { e.preventDefault(); document.getElementById('uploadArea').classList.add('dragover'); }"
      ondragleave="document.getElementById('uploadArea').classList.remove('dragover')"
      onclick="document.getElementById('fileInput').click()">
      <div class="upload-icon">üìã</div>
      <h3>Trascina il PDF qui oppure clicca per selezionare</h3>
      <p>Qualsiasi operatore ‚Ä¢ Qualsiasi numero di pagine ‚Ä¢ Max 10 MB</p>
    </div>
    <input type="file" id="fileInput" class="file-input" accept=".pdf" onchange="handleFile(event)">
    <div class="status-bar" id="statusBar">
      <div class="spinner"></div>
      <span id="statusText">Analisi in corso...</span>
    </div>
  </div>

  <!-- Risultati -->
  <div class="results" id="results">

    <!-- Consumi rilevati -->
    <div class="detail-card" style="margin-bottom:16px;">
      <h3>üìä Dati Rilevati dalla Bolletta</h3>
      <div class="consumo-info">
        <div class="ci-badge"><strong id="r-kwh">--</strong>kWh/anno consumo</div>
        <div class="ci-badge"><strong id="r-mesi">--</strong>mesi fatturati</div>
        <div class="ci-badge"><strong id="r-operatore">--</strong>operatore attuale</div>
        <div class="ci-badge"><strong id="r-media-att">--</strong>‚Ç¨/kWh prezzo medio attuale</div>
      </div>
    </div>

    <!-- Hero risparmio -->
    <div class="hero-risparmio" id="heroBox">
      <div class="label">Risparmio Annuale Stimato</div>
      <div class="amount" id="heroAmount">--</div>
      <div class="sub" id="heroSub">--</div>
      <div class="perc-badge save" id="heroPerc">--</div>
    </div>

    <!-- Numeri principali -->
    <div class="numbers-grid">
      <div class="num-card current">
        <div class="nc-label">Paga ora con</div>
        <div class="nc-operator" id="nc-op-current">--</div>
        <div class="nc-value red" id="nc-attuale">--</div>
        <div class="nc-unit">‚Ç¨ / anno (stimato)</div>
      </div>
      <div class="num-card offer">
        <div class="nc-label">Con WindTre pagherebbe</div>
        <div class="nc-operator">WindTre Energia</div>
        <div class="nc-value purple" id="nc-offerta">--</div>
        <div class="nc-unit">‚Ç¨ / anno</div>
      </div>
    </div>

    <!-- Grafico donut -->
    <div class="chart-card">
      <h3>üìä Distribuzione Spesa Annuale</h3>
      <div class="chart-wrap">
        <canvas id="myChart" width="280" height="280"></canvas>
        <div class="chart-center">
          <div class="c-perc green" id="chartPerc">--</div>
          <div class="c-euro" id="chartEuro">risparmio</div>
        </div>
      </div>
      <div class="chart-legend">
        <span><span class="legend-dot" style="background:#7c3aed;"></span>WindTre (nostra offerta)</span>
        <span><span class="legend-dot" style="background:#22c55e;"></span>Risparmio</span>
        <span><span class="legend-dot" style="background:rgba(239,68,68,0.7);"></span>Costo aggiuntivo se pi√π cara</span>
      </div>
    </div>

    <!-- Bonus WindTre -->
    <div class="bonus-note">
      üéÅ <strong>Bonus incluso: 120 ‚Ç¨ il primo anno</strong> ‚Äî 10 ‚Ç¨ accreditati ogni mese per 12 mesi. Il risparmio reale il primo anno √® ancora maggiore: <strong id="bonusTotal">--</strong> ‚Ç¨
    </div>

    <!-- Dettaglio calcolo -->
    <div class="detail-card">
      <h3>üîç Dettaglio Calcolo Confronto</h3>

      <div class="detail-section">
        <div class="detail-section-title">üìå Bolletta Attuale Cliente</div>
        <div class="detail-row"><span class="dr-label">Operatore attuale</span><span class="dr-value" id="d-op">--</span></div>
        <div class="detail-row"><span class="dr-label">Consumo annuo</span><span class="dr-value" id="d-kwh">--</span></div>
        <div class="detail-row"><span class="dr-label">Spesa annua stimata</span><span class="dr-value red" id="d-spesa-att">--</span></div>
        <div class="detail-row"><span class="dr-label">Prezzo medio attuale (IVA incl.)</span><span class="dr-value" id="d-media">--</span></div>
        <div class="detail-row"><span class="dr-label">di cui quota fissa stimata</span><span class="dr-value" id="d-fissa-att">--</span></div>
        <div class="detail-row"><span class="dr-label">di cui energia (variabile)</span><span class="dr-value" id="d-var-att">--</span></div>
      </div>

      <div class="detail-section">
        <div class="detail-section-title">üíú Offerta WindTre</div>
        <div class="detail-row"><span class="dr-label">PUN Index GME (Gen 2026)</span><span class="dr-value">0,1197 ‚Ç¨/kWh</span></div>
        <div class="detail-row"><span class="dr-label">+ Corrispettivo consumo WindTre</span><span class="dr-value">0,0278 ‚Ç¨/kWh</span></div>
        <div class="detail-row"><span class="dr-label">Prezzo energia WindTre (lordo IVA)</span><span class="dr-value purple" id="d-prezzo-wt">--</span></div>
        <div class="detail-row"><span class="dr-label">Costo energia (kWh √ó prezzo)</span><span class="dr-value" id="d-energia-wt">--</span></div>
        <div class="detail-row"><span class="dr-label">Quota fissa annua</span><span class="dr-value">90,00 ‚Ç¨</span></div>
        <div class="detail-row"><span class="dr-label">Rete + oneri (uguali per tutti)</span><span class="dr-value" id="d-rete-wt">--</span></div>
        <div class="total-row"><span style="color:var(--text2)">Totale Offerta WindTre</span><span style="color:var(--primary-light)" id="d-totale-wt">--</span></div>
      </div>

      <div class="detail-section">
        <div class="detail-section-title">‚úÖ Risultato</div>
        <div class="detail-row"><span class="dr-label">Risparmio annuo (senza bonus)</span><span class="dr-value green" id="d-risparmio">--</span></div>
        <div class="detail-row"><span class="dr-label">Bonus primo anno</span><span class="dr-value green">+ 120,00 ‚Ç¨</span></div>
        <div class="detail-row"><span class="dr-label" style="font-weight:700;color:var(--text)">Risparmio totale primo anno</span><span class="dr-value green" style="font-size:1.05rem" id="d-risparmio-bonus">--</span></div>
        <div class="detail-row"><span class="dr-label">Variazione %</span><span class="dr-value" id="d-perc">--</span></div>
      </div>
    </div>

  </div><!-- /results -->

</div><!-- /container -->

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // ‚îÄ‚îÄ TARIFFE WINDTRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const WT = {
    punGen2026: (0.1296 + 0.1240 + 0.1055) / 3,  // media F1+F2+F3 = 0.11970 ‚Ç¨/kWh
    corrispettivo: 0.0278,    // ‚Ç¨/kWh corrispettivo consumo WindTre
    quotaFissaAnno: 90.00,    // ‚Ç¨/anno bloccata 24 mesi
    bonus: 120.00,            // ‚Ç¨ primo anno
    iva: 0.10                 // IVA 10% domestico
  };

  let chartInstance = null;

  // ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function handleDrop(e) {
    e.preventDefault();
    document.getElementById('uploadArea').classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') processFile(f);
    else showMsg('error', 'Carica un file PDF valido.');
  }
  function handleFile(e) { if (e.target.files[0]) processFile(e.target.files[0]); }

  const ua = document.getElementById('uploadArea');
  ua.addEventListener('dragover', e => { e.preventDefault(); ua.classList.add('dragover'); });
  ua.addEventListener('dragleave', e => { e.preventDefault(); ua.classList.remove('dragover'); });

  // ‚îÄ‚îÄ ELABORAZIONE PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function processFile(file) {
    const sb = document.getElementById('statusBar');
    const st = document.getElementById('statusText');
    sb.style.display = 'flex';
    document.getElementById('results').style.display = 'none';
    st.textContent = 'Lettura PDF...';

    try {
      if (file.size > 10485760) { showMsg('error', 'File troppo grande (max 10MB)'); sb.style.display='none'; return; }
      const buf = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: buf }).promise;
      st.textContent = 'Analisi ' + pdf.numPages + ' pagine...';
      let testo = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page = await pdf.getPage(p);
        const c = await page.getTextContent();
        testo += c.items.map(i => i.str).join(' ') + '\n';
      }
      st.textContent = 'Estrazione dati bolletta...';
      const resp = await fetch('/api/estrai-bolletta?tipo=luce', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: testo })
      });
      const data = await resp.json();
      if (!data.success) {
        showMsg('error', '‚ö†Ô∏è ' + (data.error || 'Dati non trovati. Verifica che sia una bolletta luce PDF.'));
        sb.style.display = 'none';
        return;
      }
      sb.style.display = 'none';
      // Cerca l'operatore nel testo
      const operatore = detectOperatore(testo);
      // Cerca spesa annua e quota fissa nel testo
      const spesaAnnua = detectSpesaAnnua(testo, data.totale, data.consumo);
      renderRisultati(data.consumo, spesaAnnua.totaleAnno, operatore, spesaAnnua.quotaFissa, spesaAnnua.mesi);
      showMsg('success', '‚úÖ Bolletta elaborata! Confronto calcolato.');
    } catch(err) {
      console.error(err);
      showMsg('error', 'Errore lettura PDF: ' + err.message);
      document.getElementById('statusBar').style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ RILEVAMENTO OPERATORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function detectOperatore(testo) {
    const t = testo.toLowerCase();
    if (t.includes('iren')) return 'IREN';
    if (t.includes('enel')) return 'Enel';
    if (t.includes('eni')) return 'Eni gas e luce';
    if (t.includes('a2a')) return 'A2A';
    if (t.includes('acea')) return 'ACEA';
    if (t.includes('sorgenia')) return 'Sorgenia';
    if (t.includes('illumia')) return 'Illumia';
    if (t.includes('eon') || t.includes('e.on')) return 'E.ON';
    if (t.includes('Edison')) return 'Edison';
    if (t.includes('plenitude') || t.includes('eni')) return 'Plenitude (ENI)';
    return 'Operatore attuale';
  }

  // ‚îÄ‚îÄ RILEVAMENTO SPESA ANNUA + QUOTA FISSA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function detectSpesaAnnua(testo, totaleBolletta, consumoBolletta) {
    // Cerca spesa annua esplicita
    const annuaMatch = testo.match(/spesa\s+annua?\s+sostenuta[^‚Ç¨\d]*[‚Ç¨\s]*([\d.,]+)/i)
      || testo.match(/[\d.,]+\s*‚Ç¨[^\n]*annua?\b/i);
    let totaleAnno = null;
    if (annuaMatch && annuaMatch[1]) {
      const v = parseFloat(annuaMatch[1].replace('.','').replace(',','.'));
      if (v > 50 && v < 10000) totaleAnno = v;
    }
    // Cerca consumo annuo per stimare spesa annua se non trovata
    let consumoAnno = consumoBolletta;
    const consumoAnnuoMatch = testo.match(/consumo\s+annuo[^0-9]*([\d.,]+)\s*kwh/i)
      || testo.match(/dal\s+\d{2}\/\d{2}\/\d{4}\s+al\s+\d{2}\/\d{2}\/\d{4}[^0-9]*([\d.,]+)\s*kwh/i);
    if (consumoAnnuoMatch && consumoAnnuoMatch[1]) {
      const v = parseFloat(consumoAnnuoMatch[1].replace('.','').replace(',','.'));
      if (v > 50 && v < 100000) consumoAnno = v;
    }
    // Cerca periodo (mesi fatturati)
    let mesi = 2;
    const mesiMatch = testo.match(/(\d+)\s+mes[ei]/i);
    if (mesiMatch) { const m = parseInt(mesiMatch[1]); if (m >= 1 && m <= 12) mesi = m; }
    // Se non trovata spesa annua, estrapola da bolletta
    if (!totaleAnno) {
      totaleAnno = parseFloat((totaleBolletta / mesi * 12).toFixed(2));
    }
    // Cerca quota fissa annua attuale
    let quotaFissa = null;
    const qfMatch = testo.match(/quota\s+fissa[^‚Ç¨\d]*([\d.,]+)\s*‚Ç¨[^/]*\/\s*mes/i)
      || testo.match(/([\d.,]+)\s*‚Ç¨[^\n]*\/\s*mes[ei][^\n]*quota\s+fissa/i);
    if (qfMatch && qfMatch[1]) {
      const v = parseFloat(qfMatch[1].replace(',','.'));
      if (v > 0 && v < 500) quotaFissa = v * 12;
    }
    if (!quotaFissa) {
      // Cerca "X ‚Ç¨/mesi" nel testo (tipo 19,55 ‚Ç¨/mesi)
      const qfMatch2 = testo.match(/([\d.,]+)\s*‚Ç¨\/mes[ei]/i);
      if (qfMatch2) {
        const v = parseFloat(qfMatch2[1].replace(',','.'));
        if (v > 0 && v < 500) quotaFissa = v * 12;
      }
    }
    return { totaleAnno, quotaFissa: quotaFissa || 0, mesi, consumoAnno };
  }

  // ‚îÄ‚îÄ RENDER RISULTATI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderRisultati(consumoAnno, spesaAttualeAnno, operatore, quotaFissaAtt, mesi) {

    // ‚îÄ‚îÄ CALCOLO OFFERTA WINDTRE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Prezzo energia WindTre (IVA 10% inclusa)
    const prezzoEnergia_netto = WT.punGen2026 + WT.corrispettivo;  // ‚Ç¨/kWh netto
    const prezzoEnergia_ivato = prezzoEnergia_netto * (1 + WT.iva);

    // Stima rete+oneri: sono fissi e uguali per tutti gli operatori.
    // Li ricaviamo sottraendo la quota energia attuale dalla spesa totale.
    // Dalla bolletta IREN: rete+oneri = 17,59+17,79=35,38‚Ç¨ per 2 mesi = ~212‚Ç¨ anno su 443kWh
    // In generale stimiamo: reteOneri = spesaAttuale - quota_energia_attuale
    // quota_energia_attuale = consumo √ó prezzo_medio_energia_variabile
    const prezzoMedioAttuale = spesaAttualeAnno / consumoAnno; // ‚Ç¨/kWh lordo tutto
    // Componente energia pura attuale (stima 55% del totale come dal dettaglio bolletta)
    const quotaEnergiaPuraAtt = spesaAttualeAnno * 0.44; // ~44% energia variabile
    const reteOneriAnno = spesaAttualeAnno - quotaEnergiaPuraAtt - quotaFissaAtt;

    // Totale offerta WindTre
    const energiaWT = prezzoEnergia_ivato * consumoAnno;
    const totaleWT = parseFloat((energiaWT + WT.quotaFissaAnno + Math.max(reteOneriAnno, 0)).toFixed(2));

    const risparmio = parseFloat((spesaAttualeAnno - totaleWT).toFixed(2));
    const risparmioConBonus = parseFloat((risparmio + WT.bonus).toFixed(2));
    const perc = parseFloat((risparmio / spesaAttualeAnno * 100).toFixed(1));
    const isSaving = risparmio >= 0;

    // ‚îÄ‚îÄ POPOLA DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    set('r-kwh', consumoAnno.toFixed(0));
    set('r-mesi', mesi);
    set('r-operatore', operatore);
    set('r-media-att', prezzoMedioAttuale.toFixed(4));

    // Hero
    const heroEl = document.getElementById('heroAmount');
    heroEl.textContent = (isSaving ? '‚Ç¨ ' : '- ‚Ç¨ ') + Math.abs(risparmio).toFixed(2);
    heroEl.className = 'amount' + (isSaving ? '' : ' negative');
    set('heroSub', isSaving
      ? 'Da ‚Ç¨ '+spesaAttualeAnno.toFixed(2)+' ('+operatore+') ‚Üí ‚Ç¨ '+totaleWT.toFixed(2)+' (WindTre) all\'anno'
      : 'L\'offerta WindTre costerebbe ‚Ç¨ '+Math.abs(risparmio).toFixed(2)+' in pi√π all\'anno'
    );
    const percEl = document.getElementById('heroPerc');
    percEl.textContent = (isSaving ? '-' : '+') + Math.abs(perc) + '% sul costo annuale';
    percEl.className = 'perc-badge ' + (isSaving ? 'save' : 'lose');

    // Numeri
    set('nc-op-current', operatore);
    set('nc-attuale', '‚Ç¨ ' + spesaAttualeAnno.toFixed(2));
    set('nc-offerta', '‚Ç¨ ' + totaleWT.toFixed(2));

    // Bonus
    set('bonusTotal', risparmioConBonus.toFixed(2));

    // Dettaglio
    set('d-op', operatore);
    set('d-kwh', consumoAnno.toFixed(0) + ' kWh/anno');
    set('d-spesa-att', '‚Ç¨ ' + spesaAttualeAnno.toFixed(2));
    set('d-media', prezzoMedioAttuale.toFixed(4) + ' ‚Ç¨/kWh');
    set('d-fissa-att', '‚Ç¨ ' + quotaFissaAtt.toFixed(2));
    set('d-var-att', '‚Ç¨ ' + quotaEnergiaPuraAtt.toFixed(2));
    set('d-prezzo-wt', prezzoEnergia_ivato.toFixed(4) + ' ‚Ç¨/kWh (IVA 10% incl.)');
    set('d-energia-wt', '‚Ç¨ ' + energiaWT.toFixed(2));
    set('d-rete-wt', '‚Ç¨ ' + Math.max(reteOneriAnno, 0).toFixed(2) + ' (stimate)');
    set('d-totale-wt', '‚Ç¨ ' + totaleWT.toFixed(2));
    const rispEl = document.getElementById('d-risparmio');
    rispEl.textContent = (isSaving ? '+ ‚Ç¨' : '- ‚Ç¨') + Math.abs(risparmio).toFixed(2);
    rispEl.className = 'dr-value ' + (isSaving ? 'green' : 'red');
    const rispBonusEl = document.getElementById('d-risparmio-bonus');
    rispBonusEl.textContent = (risparmioConBonus >= 0 ? '+ ‚Ç¨' : '- ‚Ç¨') + Math.abs(risparmioConBonus).toFixed(2);
    const percDetEl = document.getElementById('d-perc');
    percDetEl.textContent = (isSaving ? '-' : '+') + Math.abs(perc) + '%';
    percDetEl.className = 'dr-value ' + (isSaving ? 'green' : 'red');

    // Grafico
    renderChart(totaleWT, risparmio, isSaving, perc);

    document.getElementById('results').style.display = 'block';
    window.scrollTo({ top: document.getElementById('results').offsetTop - 20, behavior: 'smooth' });
  }

  // ‚îÄ‚îÄ GRAFICO DONUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderChart(totaleWT, risparmio, isSaving, perc) {
    if (chartInstance) chartInstance.destroy();
    const ctx = document.getElementById('myChart').getContext('2d');
    chartInstance = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: isSaving ? [totaleWT, Math.abs(risparmio)] : [totaleWT, 0.001],
          backgroundColor: isSaving
            ? ['rgba(124,58,237,0.85)', 'rgba(34,197,94,0.85)']
            : ['rgba(239,68,68,0.7)', 'rgba(124,58,237,0.3)'],
          borderColor: '#0f0f1a',
          borderWidth: 3,
          hoverOffset: 6
        }]
      },
      options: {
        cutout: '68%',
        animation: { duration: 1000 },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: ctx => ' ‚Ç¨ ' + ctx.parsed.toFixed(2)
            }
          }
        }
      }
    });
    const percEl = document.getElementById('chartPerc');
    percEl.textContent = (isSaving ? '-' : '+') + Math.abs(perc) + '%';
    percEl.className = 'c-perc ' + (isSaving ? 'green' : 'red');
    set('chartEuro', (isSaving ? 'risparmio' : 'costo aggiuntivo'));
  }

  function set(id, val) { document.getElementById(id).textContent = val; }

  function showMsg(type, msg) {
    const el = document.getElementById(type === 'error' ? 'msgError' : 'msgSuccess');
    el.textContent = msg; el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 6000);
  }
</script>
</body>
</html>

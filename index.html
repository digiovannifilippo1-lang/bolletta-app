<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preventivo Energetico PRO</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --color-primary: #38bdf8;
      --color-success: #22c55e;
      --color-error: #ef4444;
      --color-bg: #0f172a;
      --color-surface: #1e293b;
      --color-text: #f1f5f9;
      --color-text-secondary: #cbd5e1;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background-color: var(--color-bg);
      color: var(--color-text);
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 960px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 40px; }
    .header h1 {
      font-size: 2.2rem;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #38bdf8, #06b6d4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .header p { color: var(--color-text-secondary); font-size: 1rem; }

    .tabs { display: flex; gap: 10px; margin-bottom: 30px; border-bottom: 2px solid rgba(56,189,248,0.2); }
    .tab-button {
      padding: 12px 28px; background: none; border: none;
      color: var(--color-text-secondary); cursor: pointer;
      font-size: 1rem; font-weight: 600;
      border-bottom: 3px solid transparent; transition: all 0.3s;
    }
    .tab-button.active { color: var(--color-primary); border-bottom-color: var(--color-primary); }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .card {
      background-color: var(--color-surface);
      border-radius: 14px;
      padding: 30px;
      border: 1px solid rgba(255,255,255,0.08);
      margin-bottom: 24px;
    }
    .card-title {
      font-size: 1.2rem; font-weight: 700;
      color: var(--color-primary);
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 10px;
    }

    /* Upload */
    .upload-area {
      border: 3px dashed rgba(56,189,248,0.4);
      border-radius: 12px; padding: 48px 20px;
      text-align: center; cursor: pointer;
      transition: all 0.3s;
      background-color: rgba(56,189,248,0.04);
    }
    .upload-area:hover { border-color: var(--color-primary); background-color: rgba(56,189,248,0.1); }
    .upload-area.dragover { border-color: var(--color-success); background-color: rgba(34,197,94,0.1); }
    .upload-icon { font-size: 3rem; margin-bottom: 12px; }
    .upload-area h3 { color: var(--color-text); margin-bottom: 6px; }
    .upload-area p { color: var(--color-text-secondary); font-size: 0.9rem; }
    .file-input { display: none; }

    /* Status */
    .status-bar {
      display: none; margin-top: 16px;
      background: rgba(56,189,248,0.1);
      border-radius: 8px; padding: 12px 16px;
      display: none; align-items: center; gap: 12px;
    }
    .loading-spinner {
      width: 18px; height: 18px;
      border: 3px solid rgba(56,189,248,0.3);
      border-top: 3px solid var(--color-primary);
      border-radius: 50%; animation: spin 1s linear infinite;
      flex-shrink: 0;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Risultati */
    .results-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr;
      gap: 16px; margin-bottom: 24px;
    }
    @media (max-width: 640px) { .results-grid { grid-template-columns: 1fr; } }
    .result-card {
      border-radius: 12px; padding: 20px; text-align: center;
      background: rgba(30,41,59,0.8);
      border: 2px solid rgba(56,189,248,0.2);
    }
    .result-card.highlight {
      background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05));
      border-color: rgba(34,197,94,0.5);
    }
    .result-card.danger-card {
      background: linear-gradient(135deg, rgba(239,68,68,0.15), rgba(239,68,68,0.05));
      border-color: rgba(239,68,68,0.5);
    }
    .rc-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: var(--color-text-secondary); margin-bottom: 8px; }
    .rc-value { font-size: 1.9rem; font-weight: 800; color: var(--color-primary); }
    .rc-value.green { color: var(--color-success); }
    .rc-value.red { color: var(--color-error); }
    .rc-unit { font-size: 0.85rem; color: var(--color-text-secondary); margin-top: 4px; }

    /* Dettaglio scomposizione */
    .breakdown { background: rgba(15,23,42,0.6); border-radius: 10px; padding: 16px; }
    .breakdown-row {
      display: flex; justify-content: space-between;
      padding: 9px 0; border-bottom: 1px solid rgba(255,255,255,0.07);
      font-size: 0.95rem;
    }
    .breakdown-row:last-child { border-bottom: none; }
    .br-label { color: var(--color-text-secondary); }
    .br-value { font-weight: 600; }

    /* Chart */
    .chart-wrap {
      position: relative; max-width: 320px;
      margin: 0 auto 10px;
    }
    .chart-center-text {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      text-align: center; pointer-events: none;
    }
    .chart-center-text .big { font-size: 2rem; font-weight: 800; color: var(--color-success); }
    .chart-center-text .big.red { color: var(--color-error); }
    .chart-center-text .small { font-size: 0.85rem; color: var(--color-text-secondary); }

    /* Messaggi */
    .msg { border-radius: 8px; padding: 14px 16px; margin-bottom: 20px; display: none; font-weight: 500; }
    .msg.error { background: rgba(239,68,68,0.15); border: 2px solid var(--color-error); color: var(--color-error); }
    .msg.success { background: rgba(34,197,94,0.15); border: 2px solid var(--color-success); color: var(--color-success); }

    /* Tariffe badge */
    .tariffe-badge {
      display: inline-flex; align-items: center; gap: 8px;
      background: rgba(56,189,248,0.1); border: 1px solid rgba(56,189,248,0.3);
      border-radius: 8px; padding: 6px 12px;
      font-size: 0.82rem; color: var(--color-text-secondary);
      margin-right: 8px; margin-bottom: 8px;
    }
    .tariffe-badge strong { color: var(--color-primary); }

    .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(56,189,248,0.3), transparent); margin: 30px 0; }

    /* Riepilogo totale */
    .total-summary {
      background: linear-gradient(135deg, rgba(56,189,248,0.1), rgba(6,182,212,0.08));
      border: 2px solid var(--color-primary); border-radius: 14px;
      padding: 28px; text-align: center;
    }
    .total-summary h2 { color: var(--color-primary); margin-bottom: 10px; }
    .total-summary .big-save { font-size: 2.8rem; font-weight: 900; color: var(--color-success); }
    .total-summary p { color: var(--color-text-secondary); margin-top: 8px; }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>‚ö° Preventivo Energetico PRO</h1>
    <p>Carica la bolletta del cliente ‚Äî il preventivo viene calcolato automaticamente con le tariffe del tuo operatore</p>
  </div>

  <div class="msg error" id="msgError"></div>
  <div class="msg success" id="msgSuccess"></div>

  <!-- Tariffe operative fisse -->
  <div class="card">
    <div class="card-title">üìã Tariffe Operatore (Gennaio 2026)</div>
    <div>
      <span class="tariffe-badge">üí° PUN F1 <strong>0,1296 ‚Ç¨/kWh</strong></span>
      <span class="tariffe-badge">üí° PUN F2 <strong>0,1240 ‚Ç¨/kWh</strong></span>
      <span class="tariffe-badge">üí° PUN F3 <strong>0,1055 ‚Ç¨/kWh</strong></span>
      <span class="tariffe-badge">üí° Perdite rete <strong>+10%</strong></span>
      <span class="tariffe-badge">üî• PSV Gas <strong>0,3488 ‚Ç¨/Smc</strong></span>
    </div>
  </div>

  <div class="tabs">
    <button class="tab-button active" onclick="switchTab('luce', event)">üí° LUCE</button>
    <button class="tab-button" onclick="switchTab('gas', event)">üî• GAS</button>
  </div>

  <!-- ========== TAB LUCE ========== -->
  <div id="luce" class="tab-content active">

    <div class="card">
      <div class="card-title">üì§ Carica Bolletta LUCE (PDF)</div>
      <div class="upload-area" id="uploadAreaLuce"
        ondrop="handleDrop(event,'luce')"
        ondragover="onDragOver(event,'luce')"
        ondragleave="onDragLeave(event,'luce')"
        onclick="document.getElementById('fileLuce').click()">
        <div class="upload-icon">üìÑ</div>
        <h3>Trascina il PDF qui oppure clicca</h3>
        <p>Qualsiasi numero di pagine ‚Ä¢ Max 10 MB</p>
      </div>
      <input type="file" id="fileLuce" class="file-input" accept=".pdf" onchange="handleFile(event,'luce')">
      <div class="status-bar" id="statusLuce">
        <div class="loading-spinner"></div>
        <span id="statusTextLuce">Caricamento...</span>
      </div>
    </div>

    <div id="resultsLuce" style="display:none;">
      <div class="results-grid">
        <div class="result-card">
          <div class="rc-label">Consumo Rilevato</div>
          <div class="rc-value" id="luce-kwh">--</div>
          <div class="rc-unit">kWh/anno</div>
        </div>
        <div class="result-card">
          <div class="rc-label">Spesa Attuale</div>
          <div class="rc-value" id="luce-attuale">--</div>
          <div class="rc-unit">‚Ç¨/anno</div>
        </div>
        <div class="result-card">
          <div class="rc-label">Con Tua Offerta</div>
          <div class="rc-value" id="luce-offerta">--</div>
          <div class="rc-unit">‚Ç¨/anno</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìä Risparmio con la Tua Offerta</div>
        <div class="chart-wrap">
          <canvas id="chartLuce" width="320" height="320"></canvas>
          <div class="chart-center-text">
            <div class="big" id="chartLucePercLabel">--</div>
            <div class="small" id="chartLuceEuroLabel">--</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:8px;">
          <span style="font-size:0.85rem;color:var(--color-text-secondary);">
            üü¢ Tua Offerta &nbsp;&nbsp; üîµ Costo Attuale
          </span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üîç Dettaglio Calcolo LUCE</div>
        <div class="breakdown">
          <div class="breakdown-row"><span class="br-label">Consumo cliente</span><span class="br-value" id="ld-kwh">--</span></div>
          <div class="breakdown-row"><span class="br-label">Spesa attuale cliente</span><span class="br-value" id="ld-attuale">--</span></div>
          <div class="breakdown-row"><span class="br-label">Prezzo medio attuale</span><span class="br-value" id="ld-media-att">--</span></div>
          <div class="breakdown-row"><span class="br-label">PUN Gen 2026 (media F1+F2+F3)</span><span class="br-value">0,1197 ‚Ç¨/kWh</span></div>
          <div class="breakdown-row"><span class="br-label">+ Perdite rete (10%)</span><span class="br-value">+0,01197 ‚Ç¨/kWh</span></div>
          <div class="breakdown-row"><span class="br-label">Prezzo energia tua offerta</span><span class="br-value" id="ld-prezzo-off">--</span></div>
          <div class="breakdown-row"><span class="br-label">Componente rete + oneri (stimata)</span><span class="br-value" id="ld-rete">--</span></div>
          <div class="breakdown-row" style="font-weight:700;font-size:1rem;">
            <span class="br-label" style="color:var(--color-text);">Totale Offerta</span>
            <span class="br-value" style="color:var(--color-primary);" id="ld-totale-off">--</span>
          </div>
          <div class="breakdown-row" style="font-weight:700;font-size:1.05rem;">
            <span class="br-label" style="color:var(--color-text);">Risparmio Annuale</span>
            <span class="br-value" id="ld-risparmio">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== TAB GAS ========== -->
  <div id="gas" class="tab-content">

    <div class="card">
      <div class="card-title">üì§ Carica Bolletta GAS (PDF)</div>
      <div class="upload-area" id="uploadAreaGas"
        ondrop="handleDrop(event,'gas')"
        ondragover="onDragOver(event,'gas')"
        ondragleave="onDragLeave(event,'gas')"
        onclick="document.getElementById('fileGas').click()">
        <div class="upload-icon">üìÑ</div>
        <h3>Trascina il PDF qui oppure clicca</h3>
        <p>Qualsiasi numero di pagine ‚Ä¢ Max 10 MB</p>
      </div>
      <input type="file" id="fileGas" class="file-input" accept=".pdf" onchange="handleFile(event,'gas')">
      <div class="status-bar" id="statusGas">
        <div class="loading-spinner"></div>
        <span id="statusTextGas">Caricamento...</span>
      </div>
    </div>

    <div id="resultsGas" style="display:none;">
      <div class="results-grid">
        <div class="result-card">
          <div class="rc-label">Consumo Rilevato</div>
          <div class="rc-value" id="gas-smc">--</div>
          <div class="rc-unit">Smc/anno</div>
        </div>
        <div class="result-card">
          <div class="rc-label">Spesa Attuale</div>
          <div class="rc-value" id="gas-attuale">--</div>
          <div class="rc-unit">‚Ç¨/anno</div>
        </div>
        <div class="result-card">
          <div class="rc-label">Con Tua Offerta</div>
          <div class="rc-value" id="gas-offerta">--</div>
          <div class="rc-unit">‚Ç¨/anno</div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üìä Risparmio con la Tua Offerta</div>
        <div class="chart-wrap">
          <canvas id="chartGas" width="320" height="320"></canvas>
          <div class="chart-center-text">
            <div class="big" id="chartGasPercLabel">--</div>
            <div class="small" id="chartGasEuroLabel">--</div>
          </div>
        </div>
        <div style="text-align:center;margin-top:8px;">
          <span style="font-size:0.85rem;color:var(--color-text-secondary);">
            üü¢ Tua Offerta &nbsp;&nbsp; üîµ Costo Attuale
          </span>
        </div>
      </div>

      <div class="card">
        <div class="card-title">üîç Dettaglio Calcolo GAS</div>
        <div class="breakdown">
          <div class="breakdown-row"><span class="br-label">Consumo cliente</span><span class="br-value" id="gd-smc">--</span></div>
          <div class="breakdown-row"><span class="br-label">Spesa attuale cliente</span><span class="br-value" id="gd-attuale">--</span></div>
          <div class="breakdown-row"><span class="br-label">Prezzo medio attuale</span><span class="br-value" id="gd-media-att">--</span></div>
          <div class="breakdown-row"><span class="br-label">PSV Gennaio 2026</span><span class="br-value">0,3488 ‚Ç¨/Smc</span></div>
          <div class="breakdown-row"><span class="br-label">Prezzo gas tua offerta</span><span class="br-value" id="gd-prezzo-off">--</span></div>
          <div class="breakdown-row"><span class="br-label">Componente rete + oneri (stimata)</span><span class="br-value" id="gd-rete">--</span></div>
          <div class="breakdown-row" style="font-weight:700;font-size:1rem;">
            <span class="br-label" style="color:var(--color-text);">Totale Offerta</span>
            <span class="br-value" style="color:var(--color-primary);" id="gd-totale-off">--</span>
          </div>
          <div class="breakdown-row" style="font-weight:700;font-size:1.05rem;">
            <span class="br-label" style="color:var(--color-text);">Risparmio Annuale</span>
            <span class="br-value" id="gd-risparmio">--</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Riepilogo totale (compare solo se entrambi calcolati) -->
  <div id="totalSummary" style="display:none;margin-top:30px;">
    <div class="divider"></div>
    <div class="total-summary">
      <h2>üéâ Risparmio Totale Annuale (Luce + Gas)</h2>
      <div class="big-save" id="totalSaveEuro">--</div>
      <p id="totalSaveText">--</p>
    </div>
  </div>

</div>

<script>
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  // ‚îÄ‚îÄ TARIFFE FISSE OPERATORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const TARIFFE = {
    luce: {
      // Media aritmetica PUN F1+F2+F3 Gennaio 2026
      pun: (0.1296 + 0.1240 + 0.1055) / 3,   // ‚âà 0.1197 ‚Ç¨/kWh
      perditeRete: 0.10                          // +10%
    },
    gas: {
      psv: 0.3488   // PSV Gennaio 2026
    }
  };

  // Prezzo energia finale luce = PUN * (1 + perditeRete)
  const LUCE_ENERGY_PRICE = TARIFFE.luce.pun * (1 + TARIFFE.luce.perditeRete);
  const GAS_ENERGY_PRICE  = TARIFFE.gas.psv;

  let charts = {};
  let savedResults = { luce: null, gas: null };

  // ‚îÄ‚îÄ TAB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function switchTab(tab, event) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(el => el.classList.remove('active'));
    document.getElementById(tab).classList.add('active');
    event.target.classList.add('active');
  }

  // ‚îÄ‚îÄ DRAG & DROP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function onDragOver(e, type) { e.preventDefault(); document.getElementById('uploadArea' + cap(type)).classList.add('dragover'); }
  function onDragLeave(e, type) { e.preventDefault(); document.getElementById('uploadArea' + cap(type)).classList.remove('dragover'); }
  function handleDrop(e, type) {
    e.preventDefault();
    document.getElementById('uploadArea' + cap(type)).classList.remove('dragover');
    const f = e.dataTransfer.files[0];
    if (f && f.type === 'application/pdf') processFile(f, type);
    else showMsg('error', 'Carica un file PDF valido.');
  }
  function handleFile(e, type) { if (e.target.files[0]) processFile(e.target.files[0], type); }
  function cap(s) { return s.charAt(0).toUpperCase() + s.slice(1); }

  // ‚îÄ‚îÄ ELABORAZIONE PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function processFile(file, type) {
    const statusDiv  = document.getElementById('status' + cap(type));
    const statusText = document.getElementById('statusText' + cap(type));
    statusDiv.style.display = 'flex';
    statusText.textContent  = 'Lettura PDF...';

    try {
      if (file.size > 10485760) { showMsg('error', 'File troppo grande (max 10MB)'); statusDiv.style.display = 'none'; return; }

      const buf  = await file.arrayBuffer();
      const pdf  = await pdfjsLib.getDocument({ data: buf }).promise;
      statusText.textContent = 'Analisi ' + pdf.numPages + ' pagine...';

      let testo = '';
      for (let p = 1; p <= pdf.numPages; p++) {
        const page    = await pdf.getPage(p);
        const content = await page.getTextContent();
        testo += content.items.map(i => i.str).join(' ') + '\n';
      }

      statusText.textContent = 'Calcolo preventivo...';
      const resp = await fetch('/api/estrai-bolletta?tipo=' + type, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text: testo })
      });
      const data = await resp.json();

      if (!data.success) {
        showMsg('error', '‚ö†Ô∏è ' + (data.error || 'Dati non trovati nella bolletta.'));
        statusDiv.style.display = 'none';
        return;
      }

      statusDiv.style.display = 'none';
      renderResults(type, data.consumo, data.totale);
      showMsg('success', '‚úÖ Bolletta ' + type.toUpperCase() + ' elaborata con successo!');

    } catch(err) {
      console.error(err);
      showMsg('error', 'Errore lettura PDF: ' + err.message);
      statusDiv.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ CALCOLO E RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderResults(type, consumo, attuale) {
    // Calcola offerta
    let energyPrice, offerCost, networkOneri;
    if (type === 'luce') {
      const avgPrice  = attuale / consumo;
      energyPrice     = LUCE_ENERGY_PRICE;
      const energyTot = energyPrice * consumo;
      networkOneri    = Math.max((avgPrice - energyPrice) * consumo, 0);
      offerCost       = parseFloat((energyTot + networkOneri).toFixed(2));
    } else {
      const avgPrice  = attuale / consumo;
      energyPrice     = GAS_ENERGY_PRICE;
      const energyTot = energyPrice * consumo;
      networkOneri    = Math.max((avgPrice - energyPrice) * consumo, 0);
      offerCost       = parseFloat((energyTot + networkOneri).toFixed(2));
    }

    const risparmio = parseFloat((attuale - offerCost).toFixed(2));
    const percRisp  = parseFloat((risparmio / attuale * 100).toFixed(1));
    savedResults[type] = { attuale, offerCost, risparmio };

    if (type === 'luce') {
      document.getElementById('luce-kwh').textContent     = consumo.toFixed(0);
      document.getElementById('luce-attuale').textContent = '‚Ç¨ ' + attuale.toFixed(2);
      document.getElementById('luce-offerta').textContent = '‚Ç¨ ' + offerCost.toFixed(2);
      // dettaglio
      const avgP = attuale / consumo;
      set('ld-kwh',       consumo.toFixed(0) + ' kWh');
      set('ld-attuale',   '‚Ç¨ ' + attuale.toFixed(2));
      set('ld-media-att', avgP.toFixed(4) + ' ‚Ç¨/kWh');
      set('ld-prezzo-off', energyPrice.toFixed(4) + ' ‚Ç¨/kWh');
      set('ld-rete',      '‚Ç¨ ' + networkOneri.toFixed(2));
      set('ld-totale-off','‚Ç¨ ' + offerCost.toFixed(2));
      const rEl = document.getElementById('ld-risparmio');
      rEl.textContent = (risparmio >= 0 ? '+' : '') + '‚Ç¨ ' + risparmio.toFixed(2) + ' (' + percRisp + '%)';
      rEl.style.color = risparmio >= 0 ? 'var(--color-success)' : 'var(--color-error)';

    } else {
      document.getElementById('gas-smc').textContent     = consumo.toFixed(0);
      document.getElementById('gas-attuale').textContent = '‚Ç¨ ' + attuale.toFixed(2);
      document.getElementById('gas-offerta').textContent = '‚Ç¨ ' + offerCost.toFixed(2);
      const avgP = attuale / consumo;
      set('gd-smc',       consumo.toFixed(0) + ' Smc');
      set('gd-attuale',   '‚Ç¨ ' + attuale.toFixed(2));
      set('gd-media-att', avgP.toFixed(4) + ' ‚Ç¨/Smc');
      set('gd-prezzo-off', energyPrice.toFixed(4) + ' ‚Ç¨/Smc');
      set('gd-rete',      '‚Ç¨ ' + networkOneri.toFixed(2));
      set('gd-totale-off','‚Ç¨ ' + offerCost.toFixed(2));
      const rEl = document.getElementById('gd-risparmio');
      rEl.textContent = (risparmio >= 0 ? '+' : '') + '‚Ç¨ ' + risparmio.toFixed(2) + ' (' + percRisp + '%)';
      rEl.style.color = risparmio >= 0 ? 'var(--color-success)' : 'var(--color-error)';
    }

    document.getElementById('results' + cap(type)).style.display = 'block';
    renderChart(type, attuale, offerCost, risparmio, percRisp);
    updateTotalSummary();
  }

  function set(id, val) { document.getElementById(id).textContent = val; }

  // ‚îÄ‚îÄ GRAFICO DONUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderChart(type, attuale, offerCost, risparmio, perc) {
    const canvasId = 'chart' + cap(type);
    const percLabelId = 'chart' + cap(type) + 'PercLabel';
    const euroLabelId = 'chart' + cap(type) + 'EuroLabel';

    if (charts[type]) { charts[type].destroy(); }

    const isSaving = risparmio >= 0;
    const ctx = document.getElementById(canvasId).getContext('2d');
    charts[type] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        datasets: [{
          data: isSaving ? [offerCost, risparmio] : [offerCost, 0],
          backgroundColor: isSaving
            ? ['rgba(56,189,248,0.85)', 'rgba(34,197,94,0.85)']
            : ['rgba(239,68,68,0.85)', 'rgba(56,189,248,0.2)'],
          borderColor: ['#0f172a', '#0f172a'],
          borderWidth: 3,
          hoverOffset: 8
        }],
        labels: ['Tua Offerta', isSaving ? 'Risparmio' : 'Costo aggiuntivo']
      },
      options: {
        cutout: '70%',
        animation: { animateRotate: true, duration: 900 },
        plugins: {
          legend: { display: false },
          tooltip: {
            callbacks: {
              label: function(ctx) {
                return ' ‚Ç¨' + ctx.parsed.toFixed(2);
              }
            }
          }
        }
      }
    });

    const percEl = document.getElementById(percLabelId);
    const euroEl = document.getElementById(euroLabelId);
    percEl.textContent = (isSaving ? '-' : '+') + Math.abs(perc) + '%';
    percEl.className   = 'big' + (isSaving ? '' : ' red');
    euroEl.textContent = (isSaving ? 'risparmi ‚Ç¨' : 'costi +‚Ç¨') + Math.abs(risparmio).toFixed(2);
  }

  // ‚îÄ‚îÄ RIEPILOGO TOTALE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateTotalSummary() {
    const l = savedResults.luce;
    const g = savedResults.gas;
    if (!l || !g) return;
    const totRisp   = (l.risparmio + g.risparmio).toFixed(2);
    const totAtt    = (l.attuale + g.attuale).toFixed(2);
    const totOffer  = (l.offerCost + g.offerCost).toFixed(2);
    const percTot   = ((totRisp / totAtt) * 100).toFixed(1);
    document.getElementById('totalSummary').style.display = 'block';
    document.getElementById('totalSaveEuro').textContent  = '‚Ç¨ ' + totRisp + ' / anno';
    document.getElementById('totalSaveText').textContent  =
      'Da ‚Ç¨ ' + totAtt + ' ‚Üí ‚Ç¨ ' + totOffer + ' (' + percTot + '% in meno)';
  }

  // ‚îÄ‚îÄ MESSAGGI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showMsg(type, msg) {
    const el = document.getElementById(type === 'error' ? 'msgError' : 'msgSuccess');
    el.textContent  = msg;
    el.style.display = 'block';
    setTimeout(() => { el.style.display = 'none'; }, 5000);
  }
</script>
</body>
</html>

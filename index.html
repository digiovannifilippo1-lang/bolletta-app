<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Preventivo Energia PRO</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
:root{--bg:#090912;--sf:#11112a;--sf2:#181830;--tx:#f1f5f9;--tx2:#8892a4;--bd:rgba(100,80,255,.18);--wt:#e07020;--opt:#0ea5e9;--ok:#22c55e;--er:#ef4444;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--tx);padding:16px;min-height:100vh;}
.wrap{max-width:900px;margin:0 auto;}
/* HEADER */
.hdr{text-align:center;padding:22px 16px 16px;background:var(--sf);border-radius:14px;border:1px solid var(--bd);margin-bottom:14px;}
.logo{font-size:1.8rem;font-weight:900;background:linear-gradient(135deg,#7c3aed,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;}
.hdr p{color:var(--tx2);margin-top:4px;font-size:.88rem;}
/* INDICI */
.indici{display:flex;flex-wrap:wrap;gap:12px;align-items:center;background:var(--sf);border-radius:11px;padding:10px 15px;border:1px solid var(--bd);margin-bottom:14px;font-size:.82rem;}
.ic{display:flex;align-items:center;gap:5px;} .ic b{color:#a78bfa;}
.ic-tag{font-size:.68rem;background:rgba(120,80,255,.16);border-radius:4px;padding:1px 6px;color:#c4b5fd;}
.ic-note{margin-left:auto;font-size:.68rem;color:var(--tx2);font-style:italic;}
/* TABS */
.tabs{display:flex;background:var(--sf);border-radius:11px;padding:3px;border:1px solid var(--bd);margin-bottom:14px;}
.tb{flex:1;padding:9px;background:none;border:none;color:var(--tx2);cursor:pointer;font-size:.95rem;font-weight:600;border-radius:9px;transition:all .2s;}
.tb.on{background:linear-gradient(135deg,#7c3aed,#4f46e5);color:#fff;}
/* CARD */
.card{background:var(--sf);border-radius:12px;padding:18px;border:1px solid var(--bd);margin-bottom:13px;}
.ctit{font-size:.95rem;font-weight:700;color:#a78bfa;margin-bottom:12px;display:flex;align-items:center;gap:7px;}
/* UPLOAD */
.dropz{border:2px dashed rgba(120,80,255,.32);border-radius:10px;padding:28px 16px;text-align:center;cursor:pointer;transition:all .25s;background:rgba(120,80,255,.03);}
.dropz:hover,.dropz.over{border-color:#7c3aed;background:rgba(120,80,255,.08);}
.dropz .ico{font-size:2rem;margin-bottom:6px;}
.dropz h3{color:var(--tx);margin-bottom:4px;font-size:.95rem;}
.dropz p{color:var(--tx2);font-size:.78rem;}
input[type=file]{display:none;}
.stbar{display:none;flex-direction:row;align-items:center;gap:10px;margin-top:10px;background:rgba(120,80,255,.09);border-radius:7px;padding:8px 12px;font-size:.85rem;}
.spin{width:14px;height:14px;border:2.5px solid rgba(120,80,255,.28);border-top:2.5px solid #7c3aed;border-radius:50%;animation:spin 1s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg)}}
/* OP SELECTOR */
.ops{display:none;margin-bottom:13px;}
.ops-t{color:var(--tx2);font-size:.84rem;margin-bottom:8px;text-align:center;}
.op-btns{display:flex;gap:10px;}
.ob{flex:1;padding:13px 8px 10px;border-radius:12px;border:2px solid transparent;cursor:pointer;transition:all .2s;background:var(--sf2);text-align:center;display:flex;flex-direction:column;align-items:center;gap:4px;}
.ob:hover{transform:translateY(-2px);}
.ob .nm{font-size:.9rem;font-weight:700;color:var(--tx2);}
.ob .sb{font-size:.68rem;color:var(--tx2);line-height:1.5;}
.ob.wt{border-color:rgba(224,112,32,.2);}.ob.wt.sel,.ob.wt:hover{background:rgba(224,112,32,.1);border-color:var(--wt);}.ob.wt.sel .nm,.ob.wt:hover .nm{color:#fdba74;}
.ob.opt{border-color:rgba(14,165,233,.2);}.ob.opt.sel,.ob.opt:hover{background:rgba(14,165,233,.1);border-color:var(--opt);}.ob.opt.sel .nm,.ob.opt:hover .nm{color:#7dd3fc;}
/* WT TOGGLE */
.wttog{display:none;background:rgba(224,112,32,.06);border:1px solid rgba(224,112,32,.25);border-radius:10px;padding:12px 14px;margin-bottom:13px;}
.wttog-t{font-size:.87rem;font-weight:600;color:#fdba74;margin-bottom:9px;}
.wt-bs{display:flex;gap:9px;}
.wtsb{flex:1;padding:9px 7px;border-radius:8px;border:2px solid transparent;cursor:pointer;font-size:.84rem;font-weight:700;transition:all .18s;background:var(--sf2);color:var(--tx2);text-align:center;}
.wtsb small{font-size:.67rem;color:var(--tx2);display:block;margin-top:2px;}
.wtsb.y.sel,.wtsb.y:hover{background:rgba(224,112,32,.16);border-color:var(--wt);color:#fdba74;}
.wtsb.n.sel,.wtsb.n:hover{background:rgba(148,163,184,.08);border-color:#94a3b8;color:#var(--tx);}
/* MSG */
.msg{border-radius:7px;padding:9px 12px;margin-bottom:12px;display:none;font-weight:500;font-size:.87rem;}
.msg.er{background:rgba(239,68,68,.08);border:1.5px solid var(--er);color:var(--er);}
.msg.ok{background:rgba(34,197,94,.08);border:1.5px solid var(--ok);color:var(--ok);}
/* RESULTS */
.res{display:none;}
/* HERO */
.hero{border-radius:12px;padding:22px 16px;text-align:center;margin-bottom:12px;border:2px solid;}
.hero.sav{background:linear-gradient(135deg,rgba(34,197,94,.08),rgba(34,197,94,.01));border-color:rgba(34,197,94,.26);}
.hero.los{background:linear-gradient(135deg,rgba(239,68,68,.08),rgba(239,68,68,.01));border-color:rgba(239,68,68,.24);}
.h-tag{font-size:.68rem;text-transform:uppercase;letter-spacing:1.2px;color:#var(--tx2);margin-bottom:3px;}
.h-big{font-size:2.7rem;font-weight:900;line-height:1.}
.h-big.g{color:var(--ok);}.h-big.r{color:var(--er);}
.h-sub{font-size:.79rem;color:var(--tx2);margin-top:5px;} .h-sub strong{color:var(--tx);}
.pill{display:inline-block;padding:3px 14px;border-radius:20px;font-weight:800;font-size:.9rem;margin-top:8px;}
.pill.g{background:rgba(34,197,94,.12);color:var(--ok);border:1.5px solid rgba(34,197,94,.22);}
.pill.r{background:rgba(239,68,68,.1);color:var(--er);border:1.5px solid rgba(239,68,68,.22);}
/* GRID */
.ng{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;}
@media(max-width:460px){.ng{grid-template-columns:1fr;}}
.nc{background:var(--sf2);border-radius:10px;padding:14px;border:1.5px solid var(--bd);}
.nc.cr{border-color:rgba(239,68,68,.18);}.nc.nw{border-color:rgba(224,112,32,.26);}.nc.no{border-color:rgba(14,165,233,.26);}
.nc-l{font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--tx2);margin-bottom:2px;}
.nc-o{font-size:.68rem;color:var(--tx2);font-style:italic;margin-bottom:4px;}
.nc-v{font-size:1.5rem;font-weight:800;}
.nc-v.r{color:#f87171;}.nc-v.or{color:#fdba74;}.nc-v.bl{color:#7dd3fc;}
.nc-u{font-size:.69rem;color:var(--tx2);margin-top:2px;}
/* CHARTS */
.ch-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;}
@media(max-width:520px){.ch-row{grid-template-columns:1fr;}}
.chc{background:var(--sf);border:1px solid var(--bd);border-radius:12px;padding:14px;}
.chc h3{color:#a78bfa;margin-bottom:10px;font-size:.83rem;text-align:center;}
.chw{position:relative;max-width:175px;margin:0 auto 8px;}
.chcen{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;pointer-events:none;}
.chcen .cb{font-size:1.35rem;font-weight:900;}.chcen .cb.g{color:var(--ok);}.chcen .cb.r{color:var(--er);}
.chcen .cs{font-size:.65rem;color:var(--tx2);}
.chl{display:flex;justify-content:center;gap:10px;font-size:.71rem;color:var(--tx2);flex-wrap:wrap;}
.dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:2px;vertical-align:middle;}
/* DETTAGLIO */
.dstit{font-size:.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--tx2);margin:12px 0 6px;padding-bottom:3px;border-bottom:1px solid rgba(255,255,255,.05);}
.dr{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid rgba(255,255,255,.04);font-size:.81rem;}
.dr:last-child{border-bottom:none;}
.dl{color:var(--tx2);}.dv{font-weight:600;}
.dv.g{color:var(--ok);}.dv.r{color:#f87171;}.dv.or{color:#fdba74;}.dv.bl{color:#7dd3fc;}
.trow{border-radius:7px;padding:6px 10px;margin-top:5px;display:flex;justify-content:space-between;font-weight:700;font-size:.87rem;}
.trow.c{background:rgba(239,68,68,.06);}.trow.w{background:rgba(224,112,32,.08);}.trow.o{background:rgba(14,165,233,.08);}
/* QF BOX */
.qfb{background:rgba(120,80,255,.05);border:1px solid rgba(120,80,255,.18);border-radius:9px;padding:11px 14px;margin-bottom:12px;}
.qfb-t{font-size:.69rem;text-transform:uppercase;letter-spacing:1px;color:#a78bfa;margin-bottom:7px;}
/* OI */
.oi{border-radius:8px;padding:10px 13px;margin-bottom:12px;font-size:.79rem;}
.oi.w{background:rgba(224,112,32,.05);border:1px solid rgba(224,112,32,.18);}
.oi.o{background:rgba(14,165,233,.05);border:1px solid rgba(14,165,233,.18);}
.oi-t{font-weight:700;margin-bottom:5px;font-size:.88rem;}
.oi-r{display:flex;gap:11px;flex-wrap:wrap;} .oi-i{color:var(--tx2);}
.oi-i b.or{color:#fdba74;} .oi-i b.bl{color:#7dd3fc;}
/* CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:11px;}
.chip{background:rgba(120,80,255,.08);border:1px solid var(--bd);border-radius:6px;padding:4px 10px;font-size:.75rem;}
.chip b{color:#a78bfa;display:block;font-size:.88rem;}
.br{color:var(--ok);font-size:.66rem;margin-left:4px;}
.bs{color:#f59e0b;font-size:.66rem;margin-left:4px;}
</style>
</head>
<body>
<div class="wrap">

<div class="hdr">
  <div class="logo">‚ö° Preventivo Energia PRO</div>
  <p>Carica la bolletta PDF ‚Äî confronto automatico WindTre / Optima</p>
</div>

<div class="indici">
  <div class="ic">üí° PUN GME: <b id="pV">0,13266</b> ‚Ç¨/kWh <span class="ic-tag" id="pM">Gen 2026</span></div>
  <div class="ic">üî• PSV: <b id="sV">0,40423</b> ‚Ç¨/Smc <span class="ic-tag" id="sM">Gen 2026</span></div>
  <div class="ic-note">Media mensile GME ¬∑ aggiornata mensilmente</div>
</div>

<div class="msg er" id="mEr"></div>
<div class="msg ok" id="mOk"></div>

<div class="tabs">
  <button class="tb on" onclick="sTab('l',event)">üí° LUCE</button>
  <button class="tb"    onclick="sTab('g',event)">üî• GAS</button>
</div>

<!-- LUCE -->
<div id="TL">
  <div class="card">
    <div class="ctit">üìÑ Bolletta LUCE (PDF)</div>
    <div class="dropz" id="DL" ondrop="onDrop(event,'l')" ondragover="onOv(event,'l')" ondragleave="onLv(event,'l')" onclick="document.getElementById('FL').click()">
      <div class="ico">üìã</div><h3>Trascina PDF o clicca per selezionare</h3>
      <p>Qualsiasi operatore italiano ¬∑ Max 10 MB</p>
    </div>
    <input type="file" id="FL" accept=".pdf" onchange="onFile(event,'l')">
    <div class="stbar" id="SBL"><div class="spin"></div><span id="STL">Lettura...</span></div>
  </div>
  <div class="ops" id="OPL">
    <div class="ops-t">Scegli operatore per il preventivo:</div>
    <div class="op-btns">
      <div class="ob wt" id="BWL" onclick="selOp('l','wt')"><span style="font-size:1.3rem">üåÄ</span><span class="nm">WindTre</span><span class="sb">PUN+0,0278 ‚Ç¨/kWh<br>Canone 90‚Äì156 ‚Ç¨/anno</span></div>
      <div class="ob opt" id="BOL" onclick="selOp('l','opt')"><span style="font-size:1.3rem">üîµ</span><span class="nm">Optima</span><span class="sb">PUN+0,0396 ‚Ç¨/kWh<br>Canone 154,80 ‚Ç¨/anno</span></div>
    </div>
  </div>
  <div class="wttog" id="WTL">
    <div class="wttog-t">üåÄ Il cliente √® gi√† cliente WindTre?</div>
    <div class="wt-bs">
      <div class="wtsb y" id="WYL" onclick="selWt('l',true)">‚úÖ S√¨, cliente WindTre<small>Canone 90 ‚Ç¨/anno</small></div>
      <div class="wtsb n" id="WNL" onclick="selWt('l',false)">‚ùå No, non √® cliente<small>Canone 156 ‚Ç¨/anno</small></div>
    </div>
  </div>
  <div class="res" id="RL"></div>
</div>

<!-- GAS -->
<div id="TG" style="display:none">
  <div class="card">
    <div class="ctit">üìÑ Bolletta GAS (PDF)</div>
    <div class="dropz" id="DG" ondrop="onDrop(event,'g')" ondragover="onOv(event,'g')" ondragleave="onLv(event,'g')" onclick="document.getElementById('FG').click()">
      <div class="ico">üìã</div><h3>Trascina PDF o clicca per selezionare</h3>
      <p>Qualsiasi operatore italiano ¬∑ Max 10 MB</p>
    </div>
    <input type="file" id="FG" accept=".pdf" onchange="onFile(event,'g')">
    <div class="stbar" id="SBG"><div class="spin"></div><span id="STG">Lettura...</span></div>
  </div>
  <div class="ops" id="OPG">
    <div class="ops-t">Scegli operatore per il preventivo:</div>
    <div class="op-btns">
      <div class="ob wt" id="BWG" onclick="selOp('g','wt')"><span style="font-size:1.3rem">üåÄ</span><span class="nm">WindTre</span><span class="sb">PSV+0,0965 ‚Ç¨/Smc<br>Canone 90‚Äì156 ‚Ç¨/anno</span></div>
      <div class="ob opt" id="BOG" onclick="selOp('g','opt')"><span style="font-size:1.3rem">üîµ</span><span class="nm">Optima</span><span class="sb">PSV+0,12 ‚Ç¨/Smc<br>Canone 162 ‚Ç¨/anno</span></div>
    </div>
  </div>
  <div class="wttog" id="WTG">
    <div class="wttog-t">üåÄ Il cliente √® gi√† cliente WindTre?</div>
    <div class="wt-bs">
      <div class="wtsb y" id="WYG" onclick="selWt('g',true)">‚úÖ S√¨, cliente WindTre<small>Canone 90 ‚Ç¨/anno</small></div>
      <div class="wtsb n" id="WNG" onclick="selWt('g',false)">‚ùå No, non √® cliente<small>Canone 156 ‚Ç¨/anno</small></div>
    </div>
  </div>
  <div class="res" id="RG"></div>
</div>

</div><!-- /wrap -->
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚îÄ‚îÄ INDICI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const IND={pun:0.132660,psv:0.404227,mese:'Gen 2026'};
(async()=>{
  try{
    const r=await fetch('/api/indici',{signal:AbortSignal.timeout(3000)});
    if(r.ok){
      const d=await r.json();
      if(d.pun)IND.pun=d.pun;
      if(d.psv)IND.psv=d.psv;
      if(d.mese)IND.mese=d.mese;
    }
  }catch(e){}
  document.getElementById('pV').textContent=IND.pun.toFixed(5);
  document.getElementById('sV').textContent=IND.psv.toFixed(5);
  document.getElementById('pM').textContent=IND.mese;
  document.getElementById('sM').textContent=IND.mese;
})();

// ‚îÄ‚îÄ TARIFFE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const TAR={
  l:{get idx(){return IND.pun;},iva:0.10,
     wt:{sp:0.0278,vc:0.0154,fWT:90,fNO:156},
     opt:{sp:0.0396,vc:0.0154,f:154.80}},
  g:{get idx(){return IND.psv;},iva:0.22,
     wt:{sp:0.0965,vc:0,fWT:90,fNO:156},
     opt:{sp:0.12,vc:0.11,f:162}}
};

// ‚îÄ‚îÄ STATO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const BD={l:null,g:null};
const SOP={l:null,g:null};
const SWT={l:null,g:null};
const CH={};

// ‚îÄ‚îÄ UI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sTab(t,e){
  ['l','g'].forEach(x=>document.getElementById('T'+x.toUpperCase()).style.display='none');
  document.querySelectorAll('.tb').forEach(b=>b.classList.remove('on'));
  document.getElementById('T'+t.toUpperCase()).style.display='block';
  e.target.classList.add('on');
}
const U=t=>t.toUpperCase();
function onOv(e,t){e.preventDefault();document.getElementById('D'+U(t)).classList.add('over');}
function onLv(e,t){e.preventDefault();document.getElementById('D'+U(t)).classList.remove('over');}
function onDrop(e,t){e.preventDefault();onLv(e,t);const f=e.dataTransfer.files[0];if(f&&f.type==='application/pdf')readPDF(f,t);else showEr('Carica un PDF valido.');}
function onFile(e,t){if(e.target.files[0])readPDF(e.target.files[0],t);}

// ‚îÄ‚îÄ LETTURA PDF + PARSING IN BROWSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function readPDF(file,t){
  const sb=document.getElementById('SB'+U(t));
  const st=document.getElementById('ST'+U(t));
  sb.style.display='flex';
  document.getElementById('R'+U(t)).style.display='none';
  document.getElementById('OP'+U(t)).style.display='none';
  document.getElementById('WT'+U(t)).style.display='none';
  resetOb(t);
  st.textContent='Lettura PDF...';
  try{
    if(file.size>10485760){showEr('File troppo grande (max 10 MB)');sb.style.display='none';return;}
    const buf=await file.arrayBuffer();
    const pdf=await pdfjsLib.getDocument({data:buf}).promise;
    st.textContent='Analisi '+pdf.numPages+' pagine...';
    let raw='';
    for(let p=1;p<=pdf.numPages;p++){
      const pg=await pdf.getPage(p);
      const c=await pg.getTextContent();
      raw+=c.items.map(i=>i.str).join(' ')+'\n';
    }
    sb.style.display='none';

    const tipo=t==='l'?'luce':'gas';
    const dati=parseBolletta(raw,tipo);

    if(!dati.consumoPer||!dati.spesaPer){
      showEr('‚ö†Ô∏è Dati principali non trovati nel PDF. Controlla che il file sia leggibile.\nAnteprima: '+raw.slice(0,200));
      return;
    }

    BD[t]=dati;
    document.getElementById('OP'+U(t)).style.display='block';
    const ua=t==='l'?'kWh':'Smc';
    showOk(
      '‚úÖ '+dati.op+
      ' ¬∑ Periodo '+dati.periodo+
      ' ¬∑ '+dati.consumoPer.toFixed(0)+' '+ua+
      ' ¬∑ ‚Ç¨ '+dati.spesaPer.toFixed(2)+' nel periodo'+
      (dati.qfAnn?' ¬∑ Canone stimato ‚Ç¨'+dati.qfAnn.toFixed(2)+'/anno':'')
      +' ‚Äî Scegli operatore'
    );
  }catch(err){console.error(err);showEr('Errore lettura PDF: '+err.message);sb.style.display='none';}
}

// ‚îÄ‚îÄ PARSING BOLLETTA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function parseBolletta(raw,tipo){
  const t=raw.replace(/\s+/g,' ');
  const tl=t.toLowerCase();

  const out={
    op:       detectOp(t),
    periodo:  '',
    consumoAnn: null,
    spesaAnn:   null,
    consumoPer: null,
    spesaPer:   null,
    mesi:       2,
    qfAnn:      null,
    qfFonte:    'stimata'
  };

  const dm=[...t.matchAll(/(\d{2}\/\d{2}\/\d{4})\s*[-‚Äì]\s*(\d{2}\/\d{2}\/\d{4})/g)];
  if(dm.length>0){
    out.periodo=dm[0][1]+' - '+dm[0][2];
    const a=pd(dm[0][1]),b=pd(dm[0][2]);
    if(a&&b){
      const mesi=Math.max(1,Math.round((b-a)/2592000000));
      if(mesi>=1&&mesi<=12)out.mesi=mesi;
    }
  }
  const mM=tl.match(/(\d)\s+mes[ei]\s+x\s+[\d,\.]+/i);
  if(mM){const v=parseInt(mM[1]);if(v>=1&&v<=12)out.mesi=v;}
  else if(tl.includes('bimestrale'))out.mesi=2;
  else if(tl.includes('trimestrale'))out.mesi=3;
  else if(tl.match(/mensile(?!.*bimestrale)/i))out.mesi=1;

  if(tipo==='luce'){
    const caPatterns=[
      /consumo\s+annuo\s+kwh[^]*?totale\s+([\d]+)\s*kwh/i,
      /consumo\s+annuo\s+kwh\s*(?:dal[^\d]*al[^\d]*)?\s*([\d]{3,5})\s*kwh/i
    ];
    for(const p of caPatterns){
      const m=tl.match(p);
      if(m){const v=pf(m[1]);if(v>=50&&v<=99999){out.consumoAnn=v;break;}}
    }
  }else{
    const caP=[
      /consumo\s+annuo[^\d]*([\d]{2,5}[,\.]?\d*)\s*(?:smc|sm3|mc)/i
    ];
    for(const p of caP){
      const m=tl.match(p);
      if(m){const v=pf(m[1]);if(v>=20&&v<=99999){out.consumoAnn=v;break;}}
    }
  }

  if(tipo==='luce'){
    const cpP=[
      /consumo\s+totale\s+fatturato[^\d]*([\d]{2,5})\s*kwh/i,
      /totale\s+consumo\s*\(kwh\)\s*([\d]{2,5})/i,
      /([\d]{2,4})\s*kwh\s+x\s+[\d,\.]+/i
    ];
    for(const p of cpP){
      const m=tl.match(p);
      if(m){const v=pf(m[1]);if(v>=5&&v<=99999){out.consumoPer=v;break;}}
    }
  }else{
    const cpP=[
      /consumo\s+(?:gas\s+)?(?:totale|fatturato)[^\d]*([\d]{1,5}[,\.]?\d*)\s*(?:smc|sm3)/i
    ];
    for(const p of cpP){
      const m=tl.match(p);
      if(m){const v=pf(m[1]);if(v>=1&&v<=99999){out.consumoPer=v;break;}}
    }
  }
  if(!out.consumoPer&&out.consumoAnn)out.consumoPer=Math.round(out.consumoAnn*(out.mesi/12));

  const tpP=[
    /totale\s+da\s+pagare[^\d]*([\d]{1,5}[,\.]\d{2})/i,
    /totale\s+bolletta[^\d‚Ç¨]*([\d]{1,5}[,\.]\d{2})/i
  ];
  for(const p of tpP){
    const m=tl.match(p);
    if(m){const v=pf(m[1]);if(v>=5&&v<=99999){out.spesaPer=v;break;}}
  }

  const saPatterns=[
    /spesa\s+annua\s+sostenuta[^\d]*([\d]{2,5}[,\.]\d{2})/i
  ];
  for(const p of saPatterns){
    const m=tl.match(p);
    if(m){const v=pf(m[1]);if(v>=30&&v<=99999){out.spesaAnn=v;break;}}
  }
  if(!out.spesaAnn&&out.spesaPer)out.spesaAnn=parseFloat((out.spesaPer*(12/out.mesi)).toFixed(2));

  const qf1=tl.match(/(\d)\s+mes[ei]\s+x\s+([\d,\.]+)\s*(?:‚Ç¨?\/?\s*mes[ei])\s+([\d,\.]+)/i);
  if(qf1){
    const nm=parseInt(qf1[1]);const totQF=pf(qf1[3]);
    if(totQF>0&&totQF<500){out.qfAnn=parseFloat((totQF*(12/nm)).toFixed(2));out.qfFonte='reale';}
  }
  if(!out.qfAnn){
    const qf2=tl.match(/quota\s+fissa[^\d]{0,20}([\d]{1,3}[,\.]\d{2})/i);
    if(qf2){
      const v=pf(qf2[1]);
      if(v>0&&v<500){out.qfAnn=parseFloat((v*(12/out.mesi)).toFixed(2));out.qfFonte='reale';}
    }
  }

  return out;
}

// ‚îÄ‚îÄ OPERATOR DETECT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function detectOp(t){
  const tl=t.toLowerCase();
  const ops=[['iren mercato','IREN Mercato'],['iren luce e gas','IREN'],['iren','IREN'],
    ['plenitude','Plenitude (ENI)'],['enel energia','Enel Energia'],['enel','Enel'],
    ['eni gas e luce','ENI Gas e Luce'],['eni ','ENI'],['a2a energia','A2A Energia'],
    ['a2a','A2A'],['acea energia','ACEA Energia'],['acea','ACEA'],['sorgenia','Sorgenia'],
    ['illumia','Illumia'],['e.on','E.ON'],['eon ','E.ON'],['edison energia','Edison'],
    ['edison','Edison'],['hera comm','Hera Comm'],['hera','Hera'],['engie','ENGIE'],
    ['bluenergy','Bluenergy'],['dolomiti energia','Dolomiti Energia'],['wekiwi','Wekiwi'],
    ['optima energia','Optima Italia'],['optima','Optima Italia'],['duferco','Duferco'],
    ['estra','Estra'],['2i rete gas','2i Rete Gas'],['italgas','Italgas']];
  for(const[k,v]of ops)if(tl.includes(k))return v;
  const m=t.match(/([A-Z√Ä√à√å√í√ô][A-Za-z√Ä-√∫\s&\.]{2,28})\s+S\.(?:p\.)?A\./);
  return m?m[1].trim():'Operatore attuale';
}

// ‚îÄ‚îÄ SELEZIONE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function selOp(t,op){
  resetOb(t);
  document.getElementById('B'+op.toUpperCase()[0]+U(t)).classList.add('sel');
  SOP[t]=op;
  document.getElementById('WT'+U(t)).style.display=op==='wt'?'block':'none';
  document.getElementById('R'+U(t)).style.display='none';
  if(op!=='wt'){SWT[t]=null;calcola(t,op);}
}
function resetOb(t){
  ['W','O'].forEach(o=>document.getElementById('B'+o+U(t)).classList.remove('sel'));
  ['Y','N'].forEach(n=>{const e=document.getElementById('W'+n+U(t));if(e)e.classList.remove('sel');});
}
function selWt(t,v){
  SWT[t]=v;
  document.getElementById('WY'+U(t)).classList.toggle('sel',v);
  document.getElementById('WN'+U(t)).classList.toggle('sel',!v);
  calcola(t,'wt');
}

// ‚îÄ‚îÄ CALCOLO SOLO SUL PERIODO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcola(t,op){
  const d=BD[t]; if(!d)return;
  const T2=TAR[t];const O=T2[op];
  const ua=t==='l'?'kWh':'Smc';
  const isWt=op==='wt';
  const opN=isWt?'WindTre':'Optima';
  const opC=isWt?'or':'bl';
  const isWtCl=isWt&&SWT[t]===true;
  const fissoAnn=isWt?(isWtCl?O.fWT:O.fNO):O.f;

  const mesi=d.mesi||2;
  const consumoPer=d.consumoPer;
  const spesaPer=d.spesaPer;
  const fattore=12/mesi;

  const pzL=parseFloat(((T2.idx+O.sp+(O.vc||0))*(1+T2.iva)).toFixed(6));

  const costoVarPer=parseFloat((pzL*consumoPer).toFixed(2));
  const costoFissoPer=parseFloat((fissoAnn*(mesi/12)).toFixed(2));
  const costoPer=costoVarPer+costoFissoPer;

  const spesaAnnAttuale=parseFloat((spesaPer*fattore).toFixed(2));
  const costoAnn=parseFloat((costoPer*fattore).toFixed(2));

  const rispPer=parseFloat((spesaPer-costoPer).toFixed(2));
  const rispAnn=parseFloat((spesaAnnAttuale-costoAnn).toFixed(2));
  const percPer=parseFloat((rispPer/spesaPer*100).toFixed(1));
  const percAnn=parseFloat((rispAnn/spesaAnnAttuale*100).toFixed(1));
  const isSav=rispPer>=0;

  const qfBadge=d.qfAnn?'<span class="br">‚úì da bolletta</span>':'<span class="bs">stima</span>';
  const indN=t==='l'?'PUN GME':'PSV';
  const consumoAnnStima=(d.consumoAnn||consumoPer*fattore).toFixed(0);

  document.getElementById('R'+U(t)).innerHTML=`

    <div class="chips">
      <div class="chip"><b>${consumoPer.toFixed(0)}</b>${ua} nel periodo</div>
      <div class="chip"><b>${consumoAnnStima}</b>${ua}/anno (stima)</div>
      <div class="chip"><b>${d.op}</b>operatore att.</div>
      <div class="chip"><b>${mesi}</b>mes${mesi===1?'e':'i'} fatturazione</div>
      <div class="chip">${d.qfAnn?`Canone attuale: ‚Ç¨ ${d.qfAnn.toFixed(2)}/anno ${qfBadge}`:'Canone attuale non disponibile'}</div>
    </div>

    <div class="oi ${isWt?'w':'o'}">
      <div class="oi-t" style="color:${isWt?'#fdba74':'#7dd3fc'}">${isWt?'üåÄ':'üîµ'} ${opN}${isWtCl?' ¬∑ Cliente WindTre ‚úÖ':''}</div>
      <div class="oi-r">
        <div class="oi-i">${indN}: <b class="${opC}">${T2.idx.toFixed(5)} ‚Ç¨/${ua}</b></div>
        <div class="oi-i">Spread: <b class="${opC}">+${O.sp} ‚Ç¨/${ua}</b></div>
        ${O.vc?`<div class="oi-i">Comm.var.: <b class="${opC}">+${O.vc} ‚Ç¨/${ua}</b></div>`:''}
        <div class="oi-i">Prezzo IVA: <b class="${opC}">${pzL.toFixed(5)} ‚Ç¨/${ua}</b></div>
        <div class="oi-i">Canone annuo: <b class="${opC}">‚Ç¨ ${fissoAnn}${isWtCl?' üè∑Ô∏è':''}</b></div>
      </div>
    </div>

    <div class="hero ${isSav?'sav':'los'}">
      <div class="h-tag">Risparmio periodo fatturazione (${mesi} mes${mesi===1?'e':'i'})</div>
      <div class="h-big ${isSav?'g':'r'}">${isSav?'':'‚àí '}‚Ç¨ ${Math.abs(rispPer).toFixed(2)}</div>
      <div class="h-sub">Con <strong>${d.op}</strong>: ‚Ç¨ ${spesaPer.toFixed(2)} ¬∑ Con <strong>${opN}</strong>: ‚Ç¨ ${costoPer.toFixed(2)}</div>
      <div class="pill ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percPer)}% sul periodo</div>
      <div style="margin-top:10px;padding-top:8px;border-top:1px solid rgba(255,255,255,.06);font-size:.78rem;color:var(--tx2)">
        Proiezione annua: <strong>${d.op} ‚Ç¨ ${spesaAnnAttuale.toFixed(2)}/anno</strong> ‚Üí <strong>${opN} ‚Ç¨ ${costoAnn.toFixed(2)}/anno</strong>
        ¬∑ Œî <strong style="color:${rispAnn>=0?'var(--ok)':'var(--er)'}">${rispAnn>=0?'‚àí ':'+ '}‚Ç¨ ${Math.abs(rispAnn).toFixed(2)}/anno</strong>
      </div>
    </div>

    <div class="ng">
      <div class="nc cr"><div class="nc-l">Periodo corrente</div><div class="nc-o">${d.op}</div>
        <div class="nc-v r">‚Ç¨ ${spesaPer.toFixed(2)}</div><div class="nc-u">stesso periodo</div></div>
      <div class="nc ${isWt?'nw':'no'}"><div class="nc-l">Con ${opN} stesso periodo</div>
        <div class="nc-o">${opN}${isWtCl?' ‚úÖ':''}</div>
        <div class="nc-v ${opC}">‚Ç¨ ${costoPer.toFixed(2)}</div><div class="nc-u">stesso periodo</div></div>
    </div>

    <div class="ch-row">
      <div class="chc">
        <h3>üìã Periodo di fatturazione</h3>
        <div class="chw"><canvas id="CP${t}" width="175" height="175"></canvas>
          <div class="chcen">
            <div class="cb ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percPer)}%</div>
            <div class="cs">${isSav?'risparmio':'extra'}</div>
          </div>
        </div>
        <div class="chl">
          <span><span class="dot" style="background:${isWt?'#e07020':'#0ea5e9'}"></span>${opN} ‚Ç¨ ${costoPer.toFixed(2)}</span>
          <span><span class="dot" style="background:${isSav?'#22c55e':'#ef4444'}"></span>${isSav?'Risp.':'Extra'} ‚Ç¨ ${Math.abs(rispPer).toFixed(2)}</span>
        </div>
      </div>
      <div class="chc">
        <h3>üìÖ Proiezione annuale</h3>
        <div class="chw"><canvas id="CA${t}" width="175" height="175"></canvas>
          <div class="chcen">
            <div class="cb ${rispAnn>=0?'g':'r'}">${rispAnn>=0?'‚àí':'+'}${Math.abs(percAnn)}%</div>
            <div class="cs">${rispAnn>=0?'risparmio':'extra'}</div>
          </div>
        </div>
        <div class="chl">
          <span><span class="dot" style="background:${isWt?'#e07020':'#0ea5e9'}"></span>${opN} ‚Ç¨ ${costoAnn.toFixed(2)}/anno</span>
          <span><span class="dot" style="background:${rispAnn>=0?'#22c55e':'#ef4444'}"></span>${rispAnn>=0?'Risp.':'Extra'} ‚Ç¨ ${Math.abs(rispAnn).toFixed(2)}/anno</span>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="ctit">üîç Dettaglio consumi e canone (annuo stimato)</div>

      <div class="dstit">${d.op} ‚Äî situazione attuale</div>
      <div class="dr"><span class="dl">Consumo annuo stimato</span><span class="dv">${consumoAnnStima} ${ua}</span></div>
      ${d.qfAnn?`<div class="dr"><span class="dl">Canone fisso annuo attuale</span><span class="dv r">‚Ç¨ ${d.qfAnn.toFixed(2)}</span></div>`:''}
      <div class="dr"><span class="dl">Spesa totale annua (proiez.)</span><span class="dv r">‚Ç¨ ${spesaAnnAttuale.toFixed(2)}</span></div>
      <div class="trow c"><span style="color:var(--tx2)">TOTALE attuale (stima annua)</span><span class="dv r">‚Ç¨ ${spesaAnnAttuale.toFixed(2)}</span></div>

      <div class="dstit">${isWt?'üåÄ':'üîµ'} ${opN} ‚Äî solo consumi + canone</div>
      <div class="dr"><span class="dl">${indN}+spread+comm. √ó IVA incl.</span><span class="dv ${opC}">${pzL.toFixed(5)} ‚Ç¨/${ua}</span></div>
      <div class="dr"><span class="dl">Consumo annuo stimato</span><span class="dv">${consumoAnnStima} ${ua}</span></div>
      <div class="dr"><span class="dl">Spesa energia annua</span><span class="dv">‚Ç¨ ${(costoVarPer*fattore).toFixed(2)}</span></div>
      <div class="dr"><span class="dl">Canone fisso annuo ${opN}</span><span class="dv ${opC}">‚Ç¨ ${fissoAnn}</span></div>
      <div class="trow ${isWt?'w':'o'}"><span style="color:var(--tx2)">TOTALE annuo ${opN} (consumi+canone)</span><span style="color:${isWt?'#fdba74':'#7dd3fc'}">‚Ç¨ ${costoAnn.toFixed(2)}</span></div>

      <div class="dstit">‚úÖ Risultato sul periodo</div>
      <div class="dr"><span class="dl">Risparmio/extra stesso periodo</span>
        <span class="dv ${isSav?'g':'r'}">${isSav?'‚àí ':'+ '}‚Ç¨ ${Math.abs(rispPer).toFixed(2)}</span></div>
      <div class="dr"><span class="dl">Variazione % sul periodo</span>
        <span class="dv ${isSav?'g':'r'}">${isSav?'‚àí':'+'}${Math.abs(percPer)}%</span></div>
      <div class="dr"><span class="dl">Risparmio/extra annuo stimato</span>
        <span class="dv ${rispAnn>=0?'g':'r'}">${rispAnn>=0?'‚àí ':'+ '}‚Ç¨ ${Math.abs(rispAnn).toFixed(2)}/anno</span></div>
    </div>
  `;

  document.getElementById('R'+U(t)).style.display='block';
  mkCharts(t,op,costoPer,rispPer,costoAnn,rispAnn,isSav);
  window.scrollTo({top:document.getElementById('R'+U(t)).offsetTop-16,behavior:'smooth'});
}

// ‚îÄ‚îÄ GRAFICI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function mkCharts(t,op,cNoPer,rispPer,costoNos,rispAnn,isSav){
  ['CP','CA'].forEach(k=>{if(CH[k+t])CH[k+t].destroy();});
  const cO=op==='wt'?'rgba(224,112,32,.85)':'rgba(14,165,233,.85)';
  function mk(id,val,diff){
    const ctx=document.getElementById(id);if(!ctx)return null;
    return new Chart(ctx.getContext('2d'),{
      type:'doughnut',
      data:{datasets:[{data:[val,Math.max(Math.abs(diff),.01)],
        backgroundColor:[cO,diff>=0?'rgba(34,197,94,.82)':'rgba(239,68,68,.75)'],
        borderColor:'#090912',borderWidth:3,hoverOffset:5}]},
      options:{cutout:'66%',animation:{duration:800},
        plugins:{legend:{display:false},tooltip:{callbacks:{label:c=>' ‚Ç¨ '+c.parsed.toFixed(2)}}}}
    });
  }
  CH['CP'+t]=mk('CP'+t,cNoPer,rispPer);
  CH['CA'+t]=mk('CA'+t,costoNos,rispAnn);
}

// ‚îÄ‚îÄ UTILITY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pf(s){return parseFloat(String(s||0).replace(/\./g,'').replace(',','.'))||0;}
function pd(s){const p=s.split('/');return p.length===3?new Date(`${p[2]}-${p[1]}-${p[0]}`):null;}
function showEr(m){const e=document.getElementById('mEr');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',8000);}
function showOk(m){const e=document.getElementById('mOk');e.textContent=m;e.style.display='block';setTimeout(()=>e.style.display='none',8000);}
</script>
</body>
</html>
